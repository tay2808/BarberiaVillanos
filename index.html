<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villanos Barber√≠a & Tattoo - Citas</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- Google Identity Services Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* Custom styles for the brand's color palette and font */
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-custom-background { background-color: #f2efe9; }
        .text-custom-foreground { color: #24211f; }
        .bg-custom-primary { background-color: #e5c100; }
        .hover\:bg-custom-primary-dark:hover { background-color: #c2a100; }
        .text-custom-primary { color: #e5c100; }

        /* Class to highlight elements actively selected by the user */
        .active-selection {
            border: 3px solid #e5c100 !important;
            background-color: #e5c100 !important;
            color: #ffffff !important;
            box-shadow: 0 4px 6px -1px rgba(229, 193, 0, 0.2), 0 2px 4px -1px rgba(229, 193, 0, 0.12);
        }
        /* Ensures text within an active element is white for readability */
        .active-selection p, .active-selection span, .active-selection h3 {
            color: #ffffff !important;
        }

        /* Styles for the notification modal */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Style for different appointment statuses */
        .attended-appointment {
            background-color: #e8f5e9; /* A very light green */
            color: #555;
        }
        .attended-appointment td {
            text-decoration: line-through;
        }

        /* --- Chatbot Styles --- */
        #chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        #chatbot-bubble {
            width: 60px;
            height: 60px;
            background-color: #e5c100; /* Color primario de Villanos */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        #chatbot-bubble:hover {
            transform: scale(1.1);
        }
        #chatbot-window {
            width: 350px;
            height: 500px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }
        .chat-header {
            background-color: #24211f; /* Color oscuro de Villanos */
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .message {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }
        .message.user {
            align-items: flex-end;
        }
        .message.bot {
            align-items: flex-start;
        }
        .message .text-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word;
        }
        .message.user .text-bubble {
            background-color: #e5c100;
            color: white;
            border-bottom-right-radius: 5px;
        }
        .message.bot .text-bubble {
            background-color: #e9e9eb;
            color: #24211f;
            border-bottom-left-radius: 5px;
        }
        .option-button {
            background-color: white;
            border: 2px solid #e5c100;
            color: #e5c100;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            margin: 4px 2px;
            transition: all 0.2s;
        }
        .option-button:hover {
            background-color: #e5c100;
            color: white;
        }
        .chat-input {
            border-top: 1px solid #ddd;
        }
        /* --- Toggle Switch --- */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #e5c100;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #e5c100;
        }
    </style>
</head>
<body class="bg-gray-200 min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="w-full max-w-4xl bg-custom-background rounded-xl shadow-lg p-4 md:p-8 space-y-8 text-custom-foreground">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 pb-4 border-b border-gray-200">
            <div class="flex items-center space-x-4">
                <img src="https://i.postimg.cc/pr2RwbzX/image.png" alt="Logo de Villanos Barber√≠a & Tattoo" class="h-24 md:h-40 w-auto" onerror="this.onerror=null;this.src='https://placehold.co/200x200/f2efe9/24211f?text=Logo';" />
            </div>
            <div id="auth-buttons" class="flex items-center space-x-4">
                <button id="auth-toggle-button" class="bg-custom-primary text-white px-6 py-3 rounded-xl font-semibold shadow-md hover:bg-custom-primary-dark transition-colors">
                    INICIAR SESI√ìN
                </button>
                <div id="user-info" class="items-center space-x-2 md:space-x-4 hidden">
                    <span id="user-display-name" class="font-semibold text-custom-foreground text-sm md:text-base"></span>
                    <button id="change-password-button" class="bg-gray-500 text-white px-3 py-2 rounded-xl font-semibold shadow-md hover:bg-gray-600 transition-colors text-xs" style="display: none;">
                        Contrase√±a
                    </button>
                    <button id="logout-button" class="bg-gray-200 text-gray-700 px-3 py-2 md:px-4 rounded-xl font-semibold shadow-md hover:bg-gray-300 transition-colors">
                        Salir
                    </button>
                    <!-- Button for Barber Panel -->
                    <button id="barber-dashboard-button" class="bg-green-500 text-white px-3 py-2 md:px-4 rounded-xl font-semibold shadow-md hover:bg-green-600 transition-colors hidden">
                        Mi Panel
                    </button>
                    <!-- Button for Admin Panel -->
                    <button id="admin-dashboard-button" class="bg-blue-500 text-white px-3 py-2 md:px-4 rounded-xl font-semibold shadow-md hover:bg-blue-600 transition-colors hidden">
                        Admin
                    </button>
                </div>
            </div>
        </header>

        <!-- Views Container (one shown at a time) -->
        <div id="views-container">
            <!-- Service Selection View (default) -->
            <div id="service-selection-view" class="space-y-6">
                <!-- Image Collage -->
                <div class="w-full mb-6">
                    <img src="https://i.postimg.cc/4yBP5VXN/Blank-8-Grids-Collage.png" alt="Collage de servicios de barber√≠a" class="w-full rounded-lg shadow-md object-cover">
                </div>
                <p class="text-center text-lg md:text-xl font-semibold text-custom-foreground whitespace-pre-line">
Somos el reducto de los caballeros, lugar donde se arregla el mundo, se come al pr√≥jimo, se oyen chismes del barrio y  simplemente se pasa el rato.
Saludos peludos.üíà‚úåüèºüòé
                </p>
                <p class="text-center text-lg md:text-xl font-semibold text-custom-foreground">
                    SELECCIONE EL TIPO DE SERVICIO
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="barber-service-card" class="bg-white rounded-xl shadow-md p-6 text-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent">
                        <i class="fas fa-cut text-5xl text-custom-primary mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">Barber√≠a y Peluquer√≠a</h3>
                        <p class="text-gray-500">Estilo y precisi√≥n para tu cabello y barba.</p>
                    </div>
                    <div id="my-appointments-card" class="bg-white rounded-xl shadow-md p-6 text-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent">
                        <i class="fas fa-calendar-alt text-5xl text-custom-primary mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">Mover o Cancelar Cita</h3>
                        <p class="text-gray-500">Gestiona tus citas agendadas.</p>
                    </div>
                    <div id="shoe-cleaning-card" class="bg-white rounded-xl shadow-md p-6 text-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent">
                        <i class="fas fa-shoe-prints text-5xl text-custom-primary mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">Limpieza de Calzado</h3>
                        <p class="text-gray-500">Devu√©lvele el brillo a tus zapatos.</p>
                    </div>
                    <div id="cap-cleaning-card" class="bg-white rounded-xl shadow-md p-6 text-center cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent">
                        <img src="https://i.postimg.cc/qBPdG2Vy/istockphoto-666753822-612x612.jpg" alt="Icono de Gorra" class="w-16 h-16 mx-auto mb-4">
                        <h3 class="text-xl font-bold mb-2">Limpieza de Gorras</h3>
                        <p class="text-gray-500">Tus gorras como nuevas.</p>
                    </div>
                </div>
            </div>

            <!-- View for Booking a Barber Appointment -->
            <div id="barber-appointment-view" class="space-y-6 hidden">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-custom-foreground">Agenda tu Cita</h2>
                    <button id="back-to-service-selection-button" class="text-gray-500 hover:underline">Volver</button>
                </div>
                <div id="client-details" class="space-y-4">
                    <h3 class="text-xl font-bold text-custom-foreground">1. Tus Datos</h3>
                    <div>
                        <label for="client-name" class="block text-sm font-medium text-gray-700">Tu Nombre</label>
                        <input type="text" id="client-name" placeholder="Para identificarte en la cita" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-custom-primary focus:ring focus:ring-custom-primary focus:ring-opacity-50 p-2" />
                    </div>
                    <div>
                        <label for="client-phone" class="block text-sm font-medium text-gray-700">Tu Tel√©fono (10 d√≠gitos)</label>
                        <input type="tel" id="client-phone" placeholder="Ej: 7711234567" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-custom-primary focus:ring focus:ring-custom-primary focus:ring-opacity-50 p-2" />
                    </div>
                </div>
                <div id="barber-services-list" class="space-y-4">
                    <h3 class="text-xl font-bold text-custom-foreground">2. Elige tu Servicio</h3>
                </div>
                <div id="barber-selection" class="space-y-4">
                    <h3 class="text-xl font-bold text-custom-foreground">3. Elige tu Barbero</h3>
                    <div id="barber-cards-container" class="flex flex-wrap gap-4">
                        <!-- Barber cards will be dynamically generated here -->
                    </div>
                </div>
                <div id="datetime-selection" class="space-y-4">
                    <h3 class="text-xl font-bold text-custom-foreground">4. Elige Fecha y Hora</h3>
                    <div id="calendar-container" class="bg-gray-100 rounded-lg p-4"></div>
                    <div id="time-slots" class="grid grid-cols-3 sm:grid-cols-4 gap-2 mt-4"></div>
                </div>
                <button id="confirm-appointment-button" class="w-full py-3 mt-4 px-4 rounded-lg transition-colors duration-200 font-semibold bg-custom-primary text-white hover:bg-custom-primary-dark">
                    Confirmar por WhatsApp
                </button>
            </div>

            <!-- Informational Views (Cleaning) -->
            <div id="shoe-cleaning-view" class="space-y-6 hidden">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-custom-foreground">Limpieza de Calzado</h2>
                    <button id="back-to-service-selection-shoe-button" class="text-gray-500 hover:underline">Volver</button>
                </div>
                <p class="text-gray-600">Servicio especializado para zapatos y botas de piel, devolvi√©ndoles su color y brillo original.</p>
                <div class="mt-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-r-lg" role="alert">
                    <p class="font-bold">¬°Importante!</p>
                    <p>Para este servicio, es necesario que acudas directamente al negocio para entregar tu calzado.</p>
                    <a href="https://maps.app.goo.gl/SRVc3g7JyoTCoQRR7" target="_blank" rel="noopener noreferrer" class="font-semibold hover:underline mt-2 inline-block">Ver ubicaci√≥n en Google Maps &rarr;</a>
                </div>
                <div class="text-center">
                    <p class="font-semibold text-xl">Costo del servicio:</p>
                    <p class="font-bold text-4xl text-custom-primary mt-2">$35.00</p>
                </div>
            </div>
            <div id="cap-cleaning-view" class="space-y-6 hidden">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-custom-foreground">Limpieza de Gorras</h2>
                    <button id="back-to-service-selection-cap-button" class="text-gray-500 hover:underline">Volver</button>
                </div>
                 <div class="mt-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-r-lg" role="alert">
                    <p class="font-bold">¬°Importante!</p>
                    <p>Para este servicio, es necesario que acudas directamente al negocio para entregar tu gorra.</p>
                    <a href="https://maps.app.goo.gl/SRVc3g7JyoTCoQRR7" target="_blank" rel="noopener noreferrer" class="font-semibold hover:underline mt-2 inline-block">Ver ubicaci√≥n en Google Maps &rarr;</a>
                </div>
                 <div class="text-center">
                    <p class="font-semibold text-xl">Costo del servicio:</p>
                    <p class="font-bold text-4xl text-custom-primary mt-2">$70.00</p>
                </div>
            </div>

            <!-- Authentication Views -->
            <div id="login-view" class="space-y-4 hidden">
                <div class="text-center"><h2 class="text-2xl font-bold text-custom-foreground">Iniciar Sesi√≥n</h2></div>
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Correo</label>
                    <input type="email" id="login-email" placeholder="tu@correo.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                    <div class="relative mt-1">
                        <input type="password" id="login-password" placeholder="********" class="block w-full rounded-md border-gray-300 shadow-sm p-2 pr-10" />
                        <button type="button" id="toggle-login-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <label for="remember-me" class="flex items-center text-sm">
                        <input type="checkbox" id="remember-me" class="rounded border-gray-300 text-custom-primary shadow-sm focus:border-custom-primary focus:ring focus:ring-custom-primary focus:ring-opacity-50">
                        <span class="ml-2 text-gray-700">Recordarme</span>
                    </label>
                    <a href="#" id="go-to-forgot-password" class="text-sm text-custom-primary hover:underline">Olvid√© mi contrase√±a</a>
                </div>
                <button id="login-button" class="w-full py-3 px-4 rounded-lg transition-colors bg-custom-primary text-white hover:bg-custom-primary-dark">Iniciar Sesi√≥n</button>
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-400 text-sm">O</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                <div id="google-login-button-container" class="flex justify-center"></div>
                <div class="text-center"><p class="text-sm text-gray-600">¬øNo tienes cuenta? <a href="#" id="go-to-register" class="text-custom-primary hover:underline">Reg√≠strate</a></p></div>
                <div class="text-center"><a href="#" id="back-to-main-from-login" class="text-gray-500 hover:underline">Volver</a></div>
            </div>
            <div id="register-view" class="space-y-4 hidden">
                 <div class="text-center"><h2 class="text-2xl font-bold text-custom-foreground">Registrarse</h2></div>
                <div>
                    <label for="register-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="register-name" placeholder="Tu nombre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                </div>
                <div>
                    <label for="register-phone" class="block text-sm font-medium text-gray-700">Tel√©fono (10 d√≠gitos)</label>
                    <input type="tel" id="register-phone" placeholder="Ej: 7711234567" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium text-gray-700">Correo</label>
                    <input type="email" id="register-email" placeholder="tu@correo.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                    <div class="relative mt-1">
                        <input type="password" id="register-password" placeholder="********" class="block w-full rounded-md border-gray-300 shadow-sm p-2 pr-10" />
                        <button type="button" id="toggle-register-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                 <div>
                    <label for="register-confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Contrase√±a</label>
                    <div class="relative mt-1">
                        <input type="password" id="register-confirm-password" placeholder="********" class="block w-full rounded-md border-gray-300 shadow-sm p-2 pr-10" />
                        <button type="button" id="toggle-confirm-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button id="register-button" class="w-full py-3 px-4 rounded-lg transition-colors bg-custom-primary text-white hover:bg-custom-primary-dark">Registrarse</button>
                <div class="text-center"><p class="text-sm text-gray-600">¬øYa tienes cuenta? <a href="#" id="go-to-login" class="text-custom-primary hover:underline">Inicia sesi√≥n</a></p></div>
            </div>

            <!-- View for Forgot Password -->
            <div id="forgot-password-view" class="space-y-6 hidden">
                <div class="text-center"><h2 class="text-2xl font-bold text-custom-foreground">Recuperar Contrase√±a</h2></div>
                <p class="text-center text-gray-600">Ingresa tu correo electr√≥nico y te enviaremos un enlace para restablecer tu contrase√±a.</p>
                <div>
                    <label for="reset-email" class="block text-sm font-medium text-gray-700">Correo Electr√≥nico</label>
                    <input type="email" id="reset-email" placeholder="tu@correo.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                </div>
                <button id="send-reset-email-button" class="w-full py-3 px-4 rounded-lg transition-colors bg-custom-primary text-white hover:bg-custom-primary-dark">Enviar Enlace</button>
                <div class="text-center"><a href="#" id="back-to-login-from-reset" class="text-gray-500 hover:underline">Volver a Iniciar Sesi√≥n</a></div>
            </div>
            
            <!-- View for Changing Password -->
            <div id="change-password-view" class="space-y-6 hidden">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-custom-foreground">Cambiar Contrase√±a</h2>
                    <button id="back-from-change-password" class="text-gray-500 hover:underline">Volver</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="current-password" class="block text-sm font-medium text-gray-700">Contrase√±a Actual</label>
                        <div class="relative mt-1">
                             <input type="password" id="current-password" placeholder="********" class="block w-full rounded-md border-gray-300 shadow-sm p-2 pr-10" />
                             <button type="button" id="toggle-current-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                                 <i class="fas fa-eye"></i>
                             </button>
                        </div>
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-700">Nueva Contrase√±a</label>
                         <div class="relative mt-1">
                            <input type="password" id="new-password" placeholder="Al menos 6 caracteres" class="block w-full rounded-md border-gray-300 shadow-sm p-2 pr-10" />
                            <button type="button" id="toggle-new-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contrase√±a</label>
                        <div class="relative mt-1">
                           <input type="password" id="confirm-new-password" placeholder="Repite la nueva contrase√±a" class="block w-full rounded-md border-gray-300 shadow-sm p-2 pr-10" />
                           <button type="button" id="toggle-confirm-new-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                               <i class="fas fa-eye"></i>
                           </button>
                       </div>
                    </div>
                </div>
                <button id="update-password-button" class="w-full py-3 mt-4 px-4 rounded-lg transition-colors duration-200 font-semibold bg-custom-primary text-white hover:bg-custom-primary-dark">
                    Actualizar Contrase√±a
                </button>
            </div>

            <!-- Admin Panel (Full Role) -->
            <div id="admin-dashboard-view" class="space-y-8 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold text-custom-foreground">Panel de Administrador</h2>
                    <button id="back-to-service-selection-admin-button" class="text-gray-500 hover:underline">Cerrar Panel</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Side columns -->
                    <div class="space-y-8">
                         <!-- Agregar Cita Manualmente -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-custom-foreground mb-4 flex items-center"><i class="fas fa-plus-circle mr-3 text-blue-500"></i>Agregar Cita Manualmente</h3>
                            <form id="manual-add-appointment-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="manual-client-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                                    <input type="text" id="manual-client-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                                </div>
                                <div>
                                    <label for="manual-client-phone" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                                    <input type="tel" id="manual-client-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                                </div>
                                <div class="md:col-span-2">
                                    <label for="manual-service" class="block text-sm font-medium text-gray-700">Servicio</label>
                                    <select id="manual-service" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm"></select>
                                </div>
                                <div>
                                    <label for="manual-barber" class="block text-sm font-medium text-gray-700">Barbero</label>
                                    <select id="manual-barber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm"></select>
                                </div>
                                <div>
                                    <label for="manual-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                                    <input type="date" id="manual-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                                </div>
                                <div>
                                    <label for="manual-time" class="block text-sm font-medium text-gray-700">Hora</label>
                                    <input type="time" id="manual-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                                </div>
                                <button type="submit" class="w-full md:col-span-2 py-2 mt-2 px-4 rounded-lg bg-custom-primary text-white hover:bg-custom-primary-dark font-semibold">Agregar</button>
                            </form>
                        </div>
                         <!-- Manage Absences -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-custom-foreground mb-4 flex items-center"><i class="fas fa-user-slash mr-3 text-red-500"></i>Gestionar Ausencias</h3>
                            <div>
                                <label for="absence-date" class="block text-sm font-medium text-gray-700">Seleccionar Fecha</label>
                                <input type="date" id="absence-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                            </div>
                            <div id="absence-barbers-checkboxes" class="space-y-2 mt-4 text-sm">
                                <!-- Checkboxes will be rendered here by JS -->
                            </div>
                            <button id="save-absences-button" class="w-full py-2 mt-4 px-4 rounded-lg bg-red-500 text-white hover:bg-red-600 font-semibold">Guardar Ausencias</button>
                        </div>
                    </div>
                    <div class="space-y-8">
                        <!-- Configuraci√≥n General -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-custom-foreground mb-4 flex items-center"><i class="fas fa-cogs mr-3 text-gray-500"></i>Configuraci√≥n General</h3>
                             <div class="flex items-center justify-between">
                                <span class="text-gray-700">Permitir a barberos ver contacto</span>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="barber-contact-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="barber-contact-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>

                        <!-- Configuraci√≥n de Horario -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                             <h3 class="text-xl font-bold text-custom-foreground mb-4 flex items-center"><i class="fas fa-user-clock mr-3 text-purple-500"></i>Configuraci√≥n de Horario</h3>
                            <div>
                                <label for="schedule-date" class="block text-sm font-medium text-gray-700">Seleccionar Fecha</label>
                                <input type="date" id="schedule-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                            </div>
                            <div id="schedule-settings-container" class="space-y-4 hidden mt-4">
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">Estado del D√≠a</label>
                                    <div class="flex items-center space-x-2">
                                        <button id="set-day-open" class="flex-1 px-3 py-2 rounded-lg bg-green-200 text-green-800 text-sm">Abierto</button>
                                        <button id="set-day-closed" class="flex-1 px-3 py-2 rounded-lg bg-red-200 text-red-800 text-sm">Cerrado</button>
                                        <button id="set-day-default" class="flex-1 px-3 py-2 rounded-lg bg-gray-200 text-gray-800 text-sm">Default</button>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                     <label class="block text-sm font-medium text-gray-700">Horario del D√≠a</label>
                                     <div class="flex items-center space-x-2">
                                        <input type="time" id="schedule-start-time" class="block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                                        <span>-</span>
                                        <input type="time" id="schedule-end-time" class="block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                                     </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">Barberos Disponibles</label>
                                    <div id="schedule-barbers-checkboxes" class="space-y-1 text-sm"></div>
                                </div>
                                <button id="save-schedule-override" class="w-full py-2 px-4 rounded-lg bg-blue-500 text-white hover:bg-blue-600 font-semibold">Guardar</button>
                            </div>
                        </div>

                        <!-- Horarios Libres -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-custom-foreground mb-4 flex items-center"><i class="fas fa-clock mr-3 text-orange-500"></i>Horarios Libres del D√≠a</h3>
                            <div>
                                <label for="admin-availability-date" class="block text-sm font-medium text-gray-700">Seleccionar Fecha</label>
                                <input type="date" id="admin-availability-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                            </div>
                            <div id="admin-availability-container" class="space-y-4 mt-4"></div>
                        </div>

                        <!-- Reportes Diarios -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-custom-foreground mb-4 flex items-center"><i class="fas fa-chart-line mr-3 text-green-500"></i>Reportes Diarios</h3>
                            <div>
                                <label for="report-date" class="block text-sm font-medium text-gray-700">Fecha del Reporte</label>
                                <input type="date" id="report-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                            </div>
                            <div id="daily-reports-container" class="space-y-4 mt-4"></div>
                        </div>
                    </div>
                     <!-- Main column -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Citas -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-2xl font-bold text-custom-foreground mb-4 flex items-center"><i class="fas fa-calendar-check mr-3 text-custom-primary"></i>Gesti√≥n de Citas <span id="appt-count" class="ml-2 text-sm text-gray-500 font-normal"></span></h3>
                            <div id="all-appointments-table-container" class="overflow-x-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Barber Panel (Restricted Role) -->
            <div id="barber-dashboard-view" class="space-y-8 hidden">
                 <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-3xl font-bold text-custom-foreground">Mis Citas de la Semana</h2>
                        <p id="barber-week-range" class="text-sm text-gray-500"></p>
                    </div>
                    <button id="back-to-service-selection-barber-button" class="text-gray-500 hover:underline">Cerrar Panel</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- ADD NEW CLIENT -->
                    <div class="space-y-8">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-custom-foreground mb-4 flex items-center"><i class="fas fa-plus-circle mr-3 text-blue-500"></i>Agregar Cliente sin Cita</h3>
                            <form id="barber-manual-add-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="barber-manual-client-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                                    <input type="text" id="barber-manual-client-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                                </div>
                                <div>
                                    <label for="barber-manual-client-phone" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                                    <input type="tel" id="barber-manual-client-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                                </div>
                                <div class="md:col-span-2">
                                    <label for="barber-manual-service" class="block text-sm font-medium text-gray-700">Servicio</label>
                                    <select id="barber-manual-service" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm"></select>
                                </div>
                                <div>
                                    <label for="barber-manual-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                                    <input type="date" id="barber-manual-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                                </div>
                                <div>
                                    <label for="barber-manual-time" class="block text-sm font-medium text-gray-700">Hora</label>
                                    <input type="time" id="barber-manual-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                                </div>
                                <button type="submit" class="w-full md:col-span-2 py-2 mt-2 px-4 rounded-lg bg-custom-primary text-white hover:bg-custom-primary-dark font-semibold">Agregar</button>
                            </form>
                        </div>
                    </div>
                    <!-- FREE TIME SLOTS -->
                    <div class="space-y-8">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-custom-foreground mb-4 flex items-center"><i class="fas fa-clock mr-3 text-orange-500"></i>Mis Horarios Libres</h3>
                             <div>
                                <label for="barber-availability-date" class="block text-sm font-medium text-gray-700">Seleccionar Fecha</label>
                                <input type="date" id="barber-availability-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm" />
                            </div>
                            <div id="barber-availability-container" class="space-y-4 mt-4"></div>
                        </div>
                    </div>
                     <!-- APPOINTMENTS LIST (MOVED TO BOTTOM) -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-2xl font-bold text-custom-foreground mb-4 flex items-center"><i class="fas fa-calendar-check mr-3 text-custom-primary"></i>Mis Citas <span id="barber-appt-count" class="ml-2 text-sm text-gray-500 font-normal"></span></h3>
                            <div id="barber-appointments-table-container" class="overflow-x-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- "View My Appointments" View -->
            <div id="my-appointments-view" class="space-y-6 hidden">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-custom-foreground">Consulta tus Citas</h2>
                    <button id="back-to-service-selection-my-appointments-button" class="text-gray-500 hover:underline">Volver</button>
                </div>
                <div class="bg-gray-100 rounded-xl shadow-md p-6 space-y-4">
                    <p class="text-center">Ingresa tu nombre y tel√©fono para encontrar tus citas.</p>
                    <form id="search-my-appointments-form" class="space-y-4">
                        <div>
                            <label for="search-client-name" class="block text-sm font-medium text-gray-700">Tu Nombre Completo</label>
                            <input type="text" id="search-client-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                        </div>
                        <div>
                            <label for="search-client-phone" class="block text-sm font-medium text-gray-700">Tu Tel√©fono (10 d√≠gitos)</label>
                            <input type="tel" id="search-client-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                        </div>
                        <button type="submit" class="w-full py-3 mt-4 px-4 rounded-lg bg-custom-primary text-white hover:bg-custom-primary-dark">Buscar mis Citas</button>
                    </form>
                </div>
                <div id="my-appointments-results-container" class="space-y-4"></div>
            </div>

            <!-- View for Moving an Appointment -->
            <div id="move-appointment-view" class="space-y-6 hidden">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-custom-foreground">Mover tu Cita</h2>
                    <button id="back-to-my-appointments-button" class="text-gray-500 hover:underline">Volver</button>
                </div>
                <div id="move-appointment-summary" class="p-4 bg-gray-100 rounded-lg text-center">
                    <!-- Summary will be injected here by JS -->
                </div>
                <div class="space-y-2">
                    <label for="move-barber-select" class="block text-sm font-medium text-gray-700">Cambiar de Barbero (opcional)</label>
                    <select id="move-barber-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                </div>
                <div class="space-y-4">
                    <h3 class="text-xl font-bold text-custom-foreground">Elige la Nueva Fecha y Hora</h3>
                    <div id="move-calendar-container" class="bg-gray-100 rounded-lg p-4"></div>
                    <div id="move-time-slots" class="grid grid-cols-3 sm:grid-cols-4 gap-2 mt-4"></div>
                </div>
                <button id="confirm-move-button" class="w-full py-3 mt-4 px-4 rounded-lg transition-colors duration-200 font-semibold bg-custom-primary text-white hover:bg-custom-primary-dark">
                    Confirmar Cambio de Cita
                </button>
            </div>

        </div>
    </div>

    <!-- Global Modal for Notifications -->
    <div id="global-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="modal-close-button">&times;</span>
            <p id="modal-message" class="text-lg"></p>
            <button id="modal-accept-button" class="mt-4 bg-custom-primary text-white px-4 py-2 rounded-lg hover:bg-custom-primary-dark transition-colors">Aceptar</button>
        </div>
    </div>
    
    <!-- Modal for Rescheduling Appointment (Admin) -->
    <div id="edit-appointment-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-custom-foreground mb-4">Mover Cita de <span id="editing-client-name"></span></h3>
            <div class="space-y-4 text-left">
                <div>
                    <label for="edit-barber-select" class="block text-sm font-medium text-gray-700">Nuevo Barbero</label>
                    <select id="edit-barber-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                </div>
                <div>
                    <label for="edit-date" class="block text-sm font-medium text-gray-700">Nueva Fecha</label>
                    <input type="date" id="edit-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                </div>
                <div>
                    <label for="edit-time" class="block text-sm font-medium text-gray-700">Nueva Hora</label>
                    <input type="time" id="edit-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button id="cancel-edit-button" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200">Cancelar</button>
                <button id="update-appointment-button" class="px-4 py-2 rounded-lg bg-custom-primary text-white hover:bg-custom-primary-dark">Actualizar Cita</button>
            </div>
        </div>
    </div>

    <!-- Modal for Payment Method -->
    <div id="payment-method-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-custom-foreground mb-4">Seleccionar M√©todo de Pago</h3>
            <p class="mb-6">¬øC√≥mo pag√≥ el cliente <span id="payment-client-name" class="font-semibold"></span>?</p>
            <div class="flex justify-center space-x-4">
                <button id="pay-cash-button" class="flex-1 px-4 py-3 rounded-lg bg-green-500 text-white hover:bg-green-600 font-semibold flex items-center justify-center space-x-2">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Efectivo</span>
                </button>
                <button id="pay-card-button" class="flex-1 px-4 py-3 rounded-lg bg-blue-500 text-white hover:bg-blue-600 font-semibold flex items-center justify-center space-x-2">
                    <i class="fas fa-credit-card"></i>
                    <span>Tarjeta</span>
                </button>
            </div>
            <button id="cancel-payment-button" class="mt-4 text-gray-500 hover:underline">Cancelar</button>
        </div>
    </div>

    <!-- Chatbot Container -->
    <div id="chatbot-container">
        <!-- Chat Window (initially hidden) -->
        <div id="chatbot-window" class="bg-white"> <!-- REMOVED hidden class -->
            <!-- Header -->
            <div class="chat-header p-4 text-white flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-robot"></i>
                    <h3 class="font-bold">Asistente Villanos</h3>
                </div>
                <button id="close-chatbot" class="text-xl">&times;</button>
            </div>
            <!-- Messages -->
            <div id="chat-messages" class="chat-messages bg-gray-50"></div>
            <!-- Options and Text Input -->
            <div id="chat-input-container" class="chat-input p-3 bg-white">
                <div id="options-container" class="flex flex-wrap justify-center mb-2"></div>
                <div id="input-form" class="flex space-x-2 hidden">
                    <input type="text" id="user-input" class="w-full border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-400" placeholder="Escribe aqu√≠...">
                    <button id="send-button" class="bg-yellow-500 text-white rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Bubble to open/close -->
        <div id="chatbot-bubble">
            <i id="chat-icon" class="fas fa-comments"></i>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, signInAnonymously, setPersistence, browserLocalPersistence, browserSessionPersistence, GoogleAuthProvider, signInWithCredential, EmailAuthProvider, reauthenticateWithCredential, updatePassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, updateDoc, serverTimestamp, getDocs, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Instances (will be initialized later) ---
        let app, auth, db;
        
        // --- Firebase config ---
        const firebaseConfig = {
            apiKey: "AIzaSyD2R_zfFCxq5jJRcSaVO0k6jgLG_kCMoxk",
            authDomain: "barberia-villanos.firebaseapp.com",
            projectId: "barberia-villanos",
            storageBucket: "barberia-villanos.appspot.com",
            messagingSenderId: "417011094347",
            appId: "1:417011094347:web:9bbd170a0897fe49fa0ece",
            measurementId: "G-13PY79Q802"
        };


        // --- Business Data and Configuration ---
        const config = {
            businessHours: { week: { start: 11, end: 20 }, saturday: { start: 11, end: 17 } },
            services: [
                { id: 'barba', name: 'Barba', price: 100, durationSlots: 1 },
                { id: 'corte', name: 'Corte', price: 150, durationSlots: 1 },
                { id: 'corte-barba', name: 'Corte y Barba', price: 200, durationSlots: 2 },
                { id: 'cejas-addon', name: 'Cejas', price: 30, durationSlots: 0 },
            ],
            barbers: [
                { id: 'tavo', name: 'Tavo' },
                { id: 'edher', name: 'Edher' }
            ],
            roles: {
                admin: 'canek93@hotmail.com',
                edher: 'edhergomez63@gmail.com',
                tavo: 'tavohernandez1707@gmail.com'
            },
            businessPhoneNumber: '5217715688607'
        };

        // --- Application State ---
        const state = {
            currentUser: null,
            userId: null,
            userRole: 'customer', // customer, barber, admin
            loggedInBarberId: null,
            currentView: 'serviceSelection', // For history management
            generalSettings: {
                allowBarberContactView: false // Default security setting
            },
            selectedService: null,
            selectedBarber: null,
            selectedDate: null,
            selectedTime: null,
            scheduleOverrides: new Map(),
            tempScheduleStatus: undefined,
            calendar: {
                month: new Date().getMonth(),
                year: new Date().getFullYear()
            },
            clientAppointments: [],
            dashboardAppointments: [],
            appointmentToProcess: null,
            reportDate: new Date().toISOString().split('T')[0],
            modalCallback: null,
            moveAppointmentData: {
                originalAppointment: null,
                newDate: null,
                newTime: null,
                newBarberId: null, 
                calendar: {
                    month: new Date().getMonth(),
                    year: new Date().getFullYear()
                }
            },
            unsubscribe: {
                client: null,
                dashboard: null,
                settings: null,
                schedule: null // New listener for schedule overrides
            },
            chatbot: {
                conversationState: 'initial',
                userData: {}
            }
        };

        // --- DOM Element Cache ---
        const dom = {};

        // --- Utility Functions ---
        const utils = {
            getLocalDateString(date = new Date()) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },
            getWeekRange() {
                const now = new Date();
                const todayDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.

                let startDate = new Date(now);
                // Adjust to the most recent Monday
                const diffToMonday = todayDay === 0 ? -6 : 1 - todayDay;
                startDate.setDate(now.getDate() + diffToMonday);

                let endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6); // This is the Sunday of the current week

                // If today is Sunday, show the upcoming week as well
                if (todayDay === 0) {
                    endDate.setDate(endDate.getDate() + 7);
                }
                
                return {
                    start: utils.getLocalDateString(startDate),
                    end: utils.getLocalDateString(endDate)
                };
            },
            getDayOfWeek(dateString) {
                const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                const [year, month, day] = dateString.split('-').map(Number);
                // Use UTC to avoid timezone-related errors where the day might shift
                const date = new Date(Date.UTC(year, month - 1, day));
                return days[date.getUTCDay()];
            },
            showView(viewName, push = true) {
                state.currentView = viewName;
                Object.values(dom.views).forEach(view => view.classList.add('hidden'));
                if (dom.views[viewName]) {
                    dom.views[viewName].classList.remove('hidden');
                }
                if (push) {
                    history.pushState({ view: viewName }, '', `#${viewName}`);
                }
                 // When showing a dashboard, ensure its data is rendered
                if (viewName === 'adminDashboard' || viewName === 'barberDashboard') {
                    eventHandlers.renderCurrentDashboard();
                }
            },
            resetAppointmentForm() {
                state.selectedService = null;
                state.selectedBarber = null;
                state.selectedDate = null;
                state.selectedTime = null;
                dom.clientNameInput.value = (state.currentUser && !state.currentUser.isAnonymous) ? state.currentUser.displayName || '' : '';
                dom.clientPhoneInput.value = '';
                document.querySelectorAll('.active-selection').forEach(el => el.classList.remove('active-selection'));
                render.timeSlots();
                render.calendar();
            },
            addMinutesToTime(timeStr, minutesToAdd) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const date = new Date();
                date.setHours(hours, minutes + minutesToAdd, 0, 0);
                return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            },
            showModal(message, onAcceptCallback = null) {
                dom.modalMessageP.innerHTML = message;
                state.modalCallback = onAcceptCallback;
                dom.globalModal.classList.remove('hidden');
            },
            hideModal() {
                dom.globalModal.classList.add('hidden');
                if (typeof state.modalCallback === 'function') state.modalCallback();
                state.modalCallback = null;
            },
            formatPhoneNumberForWhatsApp(phone) {
                const cleanPhone = String(phone).replace(/\D/g, '');
                return cleanPhone.length === 10 ? `52${cleanPhone}` : cleanPhone;
            },
            cleanPhoneNumber(phone) {
                let cleanPhone = String(phone).replace(/\D/g, '');
                if (cleanPhone.length === 12 && cleanPhone.startsWith('52')) {
                    cleanPhone = cleanPhone.substring(2);
                }
                return cleanPhone;
            },
            validateMexicanPhoneNumber(phone) {
                const cleanPhone = utils.cleanPhoneNumber(phone);
                if (cleanPhone.length !== 10) {
                    return false;
                }
                const ladas = new Set([
                    '55', '33', '81', '449', '461', '938', '834', '987', '618', '473', '462', '477', '868', '782', '222', 
                    '442', '899', '464', '844', '444', '472', '833', '311', '779', '722', '771', '772', '775', '871', '229', '325', '633', '597', 
                    '732', '317', '958', '624', '828', '981', '645', '998', '983', '614', '756', '747', '877', '648', '613', 
                    '639', '341', '786', '656', '831', '791', '312', '271', '735', '777', '481', '475', '646', '324', '676', 
                    '622', '662', '435', '917', '727', '733', '721', '228', '463', '494', '734', '971', '393', '612', '352', 
                    '474', '284', '728', '354', '632', '314', '232', '669', '999', '686', '922', '754', '826', '443', '642', 
                    '631', '867', '392', '626', '272', '771', '842', '469', '758', '878', '638', '322', '438', '487', '661', 
                    '861', '353', '466', '967', '841', '381', '427', '415', '891', '713', '384', '356', '762', '389', '238', 
                    '736', '714', '374', '595', '231', '664', '757', '246', '773', '775', '783', '287', '961', '452', '726', 
                    '993', '436', '492', '351', '755', '715', '591', '744', '862', '453', '244', '767', '625', '644', '921', 
                    '667', '493', '673', '687', '615', '647', '243', '668', '488', '866', '634', '636', '951', '627', '294', 
                    '653', '323', '962', '665', '313', '378', '965', '451'
                ]);
                
                const prefix3 = cleanPhone.substring(0, 3);
                const prefix2 = cleanPhone.substring(0, 2);

                return ladas.has(prefix3) || ladas.has(prefix2);
            },
            formatTime12Hour(time24) {
                if (!time24) return '';
                const [hours, minutes] = time24.split(':');
                const h = parseInt(hours, 10);
                const suffix = h >= 12 ? 'PM' : 'AM';
                const hour12 = ((h + 11) % 12 + 1);
                return `${hour12}:${minutes.padStart(2, '0')} ${suffix}`;
            },
            togglePasswordVisibility(input, button) {
                const icon = button.querySelector('i');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            },
            // --- UNIFIED SCHEDULE LOGIC ---
            // This function is now the single source of truth for schedule information.
            // It relies on the real-time listener to keep the local `state.scheduleOverrides` cache up to date.
            getScheduleForDate(dateString) {
                // First, check the live-updated local cache for an override.
                if (state.scheduleOverrides.has(dateString)) {
                    return state.scheduleOverrides.get(dateString);
                }

                // If no override is in the cache, calculate the default schedule based on the config.
                const [year, month, day] = dateString.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                const dayOfWeek = date.getUTCDay();
                
                if (dayOfWeek === 0) { // Sunday
                    return { isOpen: false, start: '00:00', end: '00:00', workingBarbers: [] };
                } else {
                    const hours = dayOfWeek === 6 ? config.businessHours.saturday : config.businessHours.week;
                    return { isOpen: true, start: `${hours.start}:00`, end: `${hours.end}:00`, workingBarbers: config.barbers.map(b => b.id) };
                }
            }
        };

        // --- Render Functions ---
        const render = {
            servicesForBooking() {
                dom.barberServicesList.innerHTML = '<h3 class="text-xl font-bold text-custom-foreground">2. Elige tu Servicio</h3>';
                config.services.forEach(service => {
                    const serviceDiv = document.createElement('div');
                    serviceDiv.className = `flex justify-between items-center p-4 rounded-lg cursor-pointer transition-colors shadow-md bg-gray-100 hover:bg-gray-200 border-2 border-transparent`;
                    serviceDiv.innerHTML = `<p class="font-semibold">${service.name} <span class="text-sm font-normal">(${service.durationSlots * 30} min)</span></p><span class="font-bold">$${service.price}</span>`;
                    serviceDiv.addEventListener('click', () => {
                        state.selectedService = service;
                        state.selectedTime = null;
                        document.querySelectorAll('#barber-services-list > div').forEach(el => el.classList.remove('active-selection'));
                        serviceDiv.classList.add('active-selection');
                        render.timeSlots();
                    });
                    dom.barberServicesList.appendChild(serviceDiv);
                });
            },
            calendar() {
                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                const firstDay = new Date(state.calendar.year, state.calendar.month, 1);
                const lastDay = new Date(state.calendar.year, state.calendar.month + 1, 0);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let daysHtml = `<div class="flex justify-between items-center mb-4"><button id="prev-month-button" class="text-xl text-gray-500 hover:text-custom-primary">&lt;</button><span class="text-lg font-semibold">${monthNames[state.calendar.month]} ${state.calendar.year}</span><button id="next-month-button" class="text-xl text-gray-500 hover:text-custom-primary">&gt;</button></div><div id="calendar-days" class="grid grid-cols-7 gap-1 text-center"><span class="font-semibold text-gray-400">Do</span><span class="font-semibold text-gray-400">Lu</span><span class="font-semibold text-gray-400">Ma</span><span class="font-semibold text-gray-400">Mi</span><span class="font-semibold text-gray-400">Ju</span><span class="font-semibold text-gray-400">Vi</span><span class="font-semibold text-gray-400">Sa</span>`;
                for (let i = 0; i < firstDay.getDay(); i++) daysHtml += `<span></span>`;

                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const day = new Date(state.calendar.year, state.calendar.month, i);
                    const isPastDay = day < today;
                    const isSelected = state.selectedDate && state.selectedDate.toDateString() === day.toDateString();
                    let dayClass = "p-2 rounded-lg text-center font-semibold";
                    if (isPastDay) {
                        dayClass += " text-gray-300 cursor-not-allowed";
                    } else {
                        dayClass += " cursor-pointer hover:bg-gray-200";
                        if (isSelected) dayClass += " active-selection";
                    }
                    daysHtml += `<div class="${dayClass}" data-day="${day.toISOString()}">${i}</div>`;
                }
                daysHtml += `</div>`;
                dom.calendarContainer.innerHTML = daysHtml;

                document.getElementById('prev-month-button').addEventListener('click', eventHandlers.prevMonth);
                document.getElementById('next-month-button').addEventListener('click', eventHandlers.nextMonth);
                document.querySelectorAll('#calendar-days > div[data-day]').forEach(dayDiv => {
                    dayDiv.addEventListener('click', eventHandlers.selectDay);
                });
            },
            async timeSlots() {
                dom.timeSlotsContainer.innerHTML = '';
                if (!state.selectedDate || !state.selectedBarber || !state.selectedService) {
                    dom.timeSlotsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">Selecciona fecha, barbero y servicio.</p>';
                    return;
                }
                
                const schedule = utils.getScheduleForDate(utils.getLocalDateString(state.selectedDate));

                if (!schedule || !schedule.isOpen || !schedule.workingBarbers.includes(state.selectedBarber.id)) {
                    dom.timeSlotsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">No hay horarios disponibles para ${state.selectedBarber.name} en esta fecha.</p>`;
                    return;
                }

                const bookedSlots = new Set();
                state.clientAppointments.forEach(appt => {
                    const serviceInfo = config.services.find(s => s.id === appt.serviceId) || { durationSlots: 1 };
                    if (serviceInfo.durationSlots > 0) {
                        for (let i = 0; i < serviceInfo.durationSlots; i++) {
                            bookedSlots.add(utils.addMinutesToTime(appt.time, i * 30));
                        }
                    }
                });

                let hasAvailableSlots = false;

                if (!schedule.start || !schedule.end) {
                    dom.timeSlotsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">Horario no disponible o no configurado para este d√≠a.</p>';
                    console.error("Schedule is missing start or end time:", schedule);
                    return;
                }

                // --- CORRECTED TIME SLOT GENERATION LOGIC ---
                const [startHour, startMinute] = schedule.start.split(':').map(Number);
                const [endHour, endMinute] = schedule.end.split(':').map(Number);
                const serviceDurationSlots = state.selectedService.durationSlots === 0 ? 1 : state.selectedService.durationSlots;
                const scheduleEndTimeMinutes = (endHour * 60) + endMinute;

                for (let h = startHour; h <= endHour; h++) {
                    const mStart = (h === startHour) ? startMinute : 0;
                    const mEnd = (h === endHour) ? endMinute : 60;

                    for (let m = mStart; m < mEnd; m += 30) {
                        const timeSlot = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                        
                        const potentialEndTimeMinutes = (h * 60 + m) + (serviceDurationSlots * 30);
                        if (potentialEndTimeMinutes > scheduleEndTimeMinutes) {
                            continue;
                        }

                        let isAvailable = true;
                        for (let i = 0; i < serviceDurationSlots; i++) {
                            const slotToVerify = utils.addMinutesToTime(timeSlot, i * 30);
                            if (bookedSlots.has(slotToVerify)) {
                                isAvailable = false;
                                break;
                            }
                        }

                        if (isAvailable) hasAvailableSlots = true;
                        
                        const button = document.createElement('button');
                        button.textContent = utils.formatTime12Hour(timeSlot);
                        button.className = `px-4 py-2 rounded-lg transition-colors text-sm font-semibold ${state.selectedTime === timeSlot ? 'active-selection' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'} ${!isAvailable ? 'bg-gray-300 text-gray-400 cursor-not-allowed' : ''}`;
                        button.disabled = !isAvailable;
                        button.addEventListener('click', () => {
                            state.selectedTime = timeSlot;
                            render.timeSlots();
                        });
                        dom.timeSlotsContainer.appendChild(button);
                    }
                }

                if (!hasAvailableSlots) {
                    dom.timeSlotsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay horarios disponibles.</p>';
                }
            },
            dashboardAppointmentsTable(container, appointments, countSpan) {
                if (appointments.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No hay citas agendadas.</p>';
                    countSpan.textContent = `(0 citas)`;
                    return;
                }

                const sortedAppointments = [...appointments].sort((a, b) => {
                    const isAAttended = a.status === 'attended';
                    const isBAttended = b.status === 'attended';

                    if (!isAAttended && isBAttended) return -1;
                    if (isAAttended && !isBAttended) return 1;

                    const dateA = new Date(`${a.date}T${a.time}`);
                    const dateB = new Date(`${b.date}T${b.time}`);

                    if (!isAAttended) {
                        return dateA - dateB;
                    }

                    if (isAAttended) {
                        return dateB - dateA;
                    }

                    return 0;
                });
                
                const showContact = state.userRole === 'admin' || state.generalSettings.allowBarberContactView;

                let tableHtml = `<table class="min-w-full bg-white rounded-lg shadow-sm"><thead><tr>
                    <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Cliente</th>
                    ${showContact ? '<th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Tel√©fono</th>' : ''}
                    <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Servicio</th>
                    ${state.userRole === 'admin' ? '<th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Barbero</th>' : ''}
                    <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">D√≠a</th>
                    <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Fecha/Hora</th>
                    <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Estado</th>
                    <th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Acciones</th>
                    ${showContact ? '<th class="py-2 px-4 border-b text-left text-sm font-semibold text-gray-600">Notificar</th>' : ''}
                </tr></thead><tbody>`;

                sortedAppointments.forEach(appt => {
                    const serviceName = config.services.find(s => s.id === appt.serviceId)?.name || 'N/A';
                    const barberName = config.barbers.find(b => b.id === appt.barberId)?.name || 'N/A';
                    
                    let statusHtml = '';
                    let rowClass = '';

                    switch(appt.status) {
                        case 'attended':
                            const paymentIcon = appt.paymentMethod === 'card' ? 'fa-credit-card' : 'fa-money-bill-wave';
                            statusHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"><i class="fas ${paymentIcon} mr-1"></i> Atendido</span>`;
                            rowClass = 'attended-appointment';
                            break;
                        default:
                            statusHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Confirmada</span>`;
                            break;
                    }

                    let actionsHtml = `<div class="flex space-x-2">`;
                    if (appt.status === 'confirmed' || appt.status === 'pending') {
                         actionsHtml += `<button class="bg-green-500 text-white px-3 py-1 rounded-md text-xs hover:bg-green-600 attend-appt-btn" data-appt-id="${appt.id}">Atender</button>`;
                    }
                    if (state.userRole === 'admin') {
                        actionsHtml += `<button class="bg-blue-500 text-white px-3 py-1 rounded-md text-xs hover:bg-blue-600 edit-appt-btn" data-appt-id="${appt.id}">Mover</button>
                                        <button class="bg-red-500 text-white px-3 py-1 rounded-md text-xs hover:bg-red-600 delete-appt-btn" data-appt-id="${appt.id}">Cancelar</button>`;
                    }
                    actionsHtml += `</div>`;
                    
                    const phoneCell = showContact ? `<td class="py-2 px-4 text-sm">${appt.clientPhone || 'N/A'}</td>` : '';
                    const notifyCell = showContact && appt.status !== 'attended' ? `<td class="py-2 px-4 text-sm"><button class="bg-purple-500 text-white px-3 py-1 rounded-md text-xs hover:bg-purple-600 notify-btn" data-appt-id="${appt.id}">‚ú® WhatsApp</button></td>` : (showContact ? '<td></td>' : '');


                    tableHtml += `<tr class="border-b last:border-b-0 ${rowClass}" data-appt-id="${appt.id}">
                        <td class="py-2 px-4 text-sm">${appt.clientName}</td>
                        ${phoneCell}
                        <td class="py-2 px-4 text-sm">${serviceName}</td>
                        ${state.userRole === 'admin' ? `<td class="py-2 px-4 text-sm">${barberName}</td>` : ''}
                        <td class="py-2 px-4 text-sm">${utils.getDayOfWeek(appt.date)}</td>
                        <td class="py-2 px-4 text-sm">${appt.date} ${utils.formatTime12Hour(appt.time)}</td>
                        <td class="py-2 px-4 text-sm">${statusHtml}</td>
                        <td class="py-2 px-4 text-sm">${actionsHtml}</td>
                        ${notifyCell}
                    </tr>`;
                });
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
                countSpan.textContent = `(${appointments.length} citas)`;

                container.querySelectorAll('.attend-appt-btn').forEach(btn => btn.addEventListener('click', eventHandlers.attendAppointment));
                if (showContact) {
                    container.querySelectorAll('.notify-btn').forEach(btn => btn.addEventListener('click', eventHandlers.notifyClient));
                }
                if (state.userRole === 'admin') {
                    container.querySelectorAll('.edit-appt-btn').forEach(btn => btn.addEventListener('click', eventHandlers.editAppointment));
                    container.querySelectorAll('.delete-appt-btn').forEach(btn => btn.addEventListener('click', eventHandlers.deleteAppointment));
                }
            },
            dailyReports() {
                const reports = {};
                const attendedAppointments = state.dashboardAppointments.filter(appt => appt.status === 'attended' && appt.date === state.reportDate);

                if (attendedAppointments.length === 0) {
                    dom.dailyReportsContainer.innerHTML = '<p class="text-gray-500">No hay citas atendidas para la fecha seleccionada.</p>';
                    return;
                }

                attendedAppointments.forEach(appt => {
                    const barber = config.barbers.find(b => b.id === appt.barberId);
                    const service = config.services.find(s => s.id === appt.serviceId);
                    if (barber && service) {
                        if (!reports[barber.id]) reports[barber.id] = { name: barber.name, totalEarnings: 0, services: {}, paymentMethods: { cash: 0, card: 0 } };
                        reports[barber.id].totalEarnings += service.price;
                        reports[barber.id].services[service.name] = (reports[barber.id].services[service.name] || 0) + 1;
                        if (appt.paymentMethod === 'card') reports[barber.id].paymentMethods.card += service.price;
                        else reports[barber.id].paymentMethods.cash += service.price;
                    }
                });

                let reportsHtml = '';
                for (const barberId in reports) {
                    const report = reports[barberId];
                    let servicesListHtml = Object.entries(report.services).map(([name, count]) => `<li>${name}: ${count}</li>`).join('');
                    reportsHtml += `<div class="p-4 bg-white rounded-lg shadow-sm">
                        <h4 class="font-semibold text-lg">${report.name}</h4>
                        <p>Ganancias Totales: <span class="font-bold text-green-600">$${report.totalEarnings.toFixed(2)}</span></p>
                        <p class="text-sm">Efectivo: <span class="font-semibold">$${report.paymentMethods.cash.toFixed(2)}</span></p>
                        <p class="text-sm">Tarjeta: <span class="font-semibold">$${report.paymentMethods.card.toFixed(2)}</span></p>
                        <h5 class="font-semibold mt-2">Servicios Realizados:</h5>
                        <ul class="list-disc list-inside ml-4 text-sm">${servicesListHtml}</ul>
                    </div>`;
                }
                dom.dailyReportsContainer.innerHTML = reportsHtml;
            },
            clientAppointmentsResults(appointments) {
                dom.myAppointmentsResultsContainer.innerHTML = '';
                if (appointments.length === 0) {
                    dom.myAppointmentsResultsContainer.innerHTML = '<p class="text-center text-gray-500">No se encontraron citas con esos datos.</p>';
                    return;
                }

                appointments.forEach(appt => {
                    const service = config.services.find(s => s.id === appt.serviceId);
                    const barber = config.barbers.find(b => b.id === appt.barberId);
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-md space-y-3';
                    card.innerHTML = `
                        <div>
                            <p class="font-bold text-lg">${service ? service.name : 'Servicio Desconocido'}</p>
                            <p class="text-gray-600">con ${barber ? barber.name : 'Barbero Desconocido'}</p>
                        </div>
                        <div>
                            <p class="font-semibold">Fecha: <span class="font-normal">${appt.date}</span></p>
                            <p class="font-semibold">Hora: <span class="font-normal">${utils.formatTime12Hour(appt.time)}</span></p>
                        </div>
                        <div class="flex justify-end space-x-2 pt-2 border-t">
                            <button class="bg-blue-500 text-white px-3 py-1 rounded-md text-xs hover:bg-blue-600 client-move-btn" data-appt-id='${appt.id}'>Mover</button>
                            <button class="bg-red-500 text-white px-3 py-1 rounded-md text-xs hover:bg-red-600 client-cancel-btn" data-appt-id='${appt.id}'>Cancelar</button>
                        </div>
                    `;
                    dom.myAppointmentsResultsContainer.appendChild(card);
                });

                document.querySelectorAll('.client-move-btn').forEach(btn => btn.addEventListener('click', (e) => eventHandlers.clientMoveAppointmentSetup(e, appointments)));
                document.querySelectorAll('.client-cancel-btn').forEach(btn => btn.addEventListener('click', eventHandlers.clientCancelAppointment));
            },
            moveCalendar() {
                const calState = state.moveAppointmentData.calendar;
                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                const firstDay = new Date(calState.year, calState.month, 1);
                const lastDay = new Date(calState.year, calState.month + 1, 0);
                const today = new Date(); today.setHours(0, 0, 0, 0);

                let daysHtml = `<div class="flex justify-between items-center mb-4"><button id="move-prev-month-button" class="text-xl text-gray-500 hover:text-custom-primary">&lt;</button><span class="text-lg font-semibold">${monthNames[calState.month]} ${calState.year}</span><button id="move-next-month-button" class="text-xl text-gray-500 hover:text-custom-primary">&gt;</button></div><div id="move-calendar-days" class="grid grid-cols-7 gap-1 text-center"><span class="font-semibold text-gray-400">Do</span><span class="font-semibold text-gray-400">Lu</span><span class="font-semibold text-gray-400">Ma</span><span class="font-semibold text-gray-400">Mi</span><span class="font-semibold text-gray-400">Ju</span><span class="font-semibold text-gray-400">Vi</span><span class="font-semibold text-gray-400">Sa</span>`;
                for (let i = 0; i < firstDay.getDay(); i++) daysHtml += `<span></span>`;

                for (let i = 1; i <= lastDay.getDate(); i++) {
                    const day = new Date(calState.year, calState.month, i);
                    const isPastDay = day < today;
                    const isSelected = state.moveAppointmentData.newDate && state.moveAppointmentData.newDate.toDateString() === day.toDateString();
                    let dayClass = "p-2 rounded-lg text-center font-semibold";
                    if (isPastDay) {
                        dayClass += " text-gray-300 cursor-not-allowed";
                    } else {
                        dayClass += " cursor-pointer hover:bg-gray-200";
                        if (isSelected) dayClass += " active-selection";
                    }
                    daysHtml += `<div class="${dayClass}" data-day="${day.toISOString()}">${i}</div>`;
                }
                daysHtml += `</div>`;
                dom.moveCalendarContainer.innerHTML = daysHtml;

                document.getElementById('move-prev-month-button').addEventListener('click', eventHandlers.movePrevMonth);
                document.getElementById('move-next-month-button').addEventListener('click', eventHandlers.moveNextMonth);
                document.querySelectorAll('#move-calendar-days > div[data-day]').forEach(dayDiv => {
                    dayDiv.addEventListener('click', eventHandlers.moveSelectDay);
                });
            },
            async moveTimeSlots() {
                dom.moveTimeSlotsContainer.innerHTML = '';
                const { originalAppointment, newDate, newBarberId } = state.moveAppointmentData;
                if (!newDate || !originalAppointment || !newBarberId) {
                    dom.moveTimeSlotsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">Selecciona un barbero y una nueva fecha.</p>';
                    return;
                }

                const schedule = await utils.getScheduleForDate(utils.getLocalDateString(newDate));

                if (!schedule || !schedule.isOpen || !schedule.workingBarbers.includes(newBarberId)) {
                    dom.moveTimeSlotsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">No hay horarios disponibles para el barbero seleccionado en esta fecha.</p>`;
                    return;
                }
                
                const bookedSlots = new Set();
                state.clientAppointments.forEach(appt => {
                    if (appt.id === originalAppointment.id) return;
                    const serviceInfo = config.services.find(s => s.id === appt.serviceId) || { durationSlots: 1 };
                    if (serviceInfo.durationSlots > 0) {
                        for (let i = 0; i < serviceInfo.durationSlots; i++) {
                            bookedSlots.add(utils.addMinutesToTime(appt.time, i * 30));
                        }
                    }
                });

                let hasAvailableSlots = false;
                const serviceToBook = config.services.find(s => s.id === originalAppointment.serviceId);
                
                if (!schedule.start || !schedule.end) {
                    dom.moveTimeSlotsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">Horario no disponible o no configurado para este d√≠a.</p>';
                    console.error("Schedule is missing start or end time for move:", schedule);
                    return;
                }
                
                // --- CORRECTED TIME SLOT GENERATION LOGIC ---
                const [startHour, startMinute] = schedule.start.split(':').map(Number);
                const [endHour, endMinute] = schedule.end.split(':').map(Number);
                const serviceDurationSlots = serviceToBook.durationSlots === 0 ? 1 : serviceToBook.durationSlots;
                const scheduleEndTimeMinutes = (endHour * 60) + endMinute;

                for (let h = startHour; h <= endHour; h++) {
                    const mStart = (h === startHour) ? startMinute : 0;
                    const mEnd = (h === endHour) ? endMinute : 60;

                    for (let m = mStart; m < mEnd; m += 30) {
                        const timeSlot = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

                        const potentialEndTimeMinutes = (h * 60 + m) + (serviceDurationSlots * 30);
                        if (potentialEndTimeMinutes > scheduleEndTimeMinutes) {
                            continue;
                        }

                        let isAvailable = true;
                        for (let i = 0; i < serviceDurationSlots; i++) {
                            const slotToVerify = utils.addMinutesToTime(timeSlot, i * 30);
                            if (bookedSlots.has(slotToVerify)) {
                                isAvailable = false;
                                break;
                            }
                        }

                        if (isAvailable) hasAvailableSlots = true;

                        const button = document.createElement('button');
                        button.textContent = utils.formatTime12Hour(timeSlot);
                        button.className = `px-4 py-2 rounded-lg transition-colors text-sm font-semibold ${state.moveAppointmentData.newTime === timeSlot ? 'active-selection' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'} ${!isAvailable ? 'bg-gray-300 text-gray-400 cursor-not-allowed' : ''}`;
                        button.disabled = !isAvailable;
                        button.addEventListener('click', () => {
                            state.moveAppointmentData.newTime = timeSlot;
                            render.moveTimeSlots();
                        });
                        dom.moveTimeSlotsContainer.appendChild(button);
                    }
                }

                if (!hasAvailableSlots) {
                    dom.moveTimeSlotsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No hay horarios disponibles.</p>';
                }
            },
            async dailyAvailability(dateString, container, barberFilter = 'all') {
                if (!dateString) {
                    container.innerHTML = '';
                    return;
                }

                const schedule = utils.getScheduleForDate(dateString);

                if (!schedule.isOpen) {
                    container.innerHTML = '<p class="text-center text-gray-500">El negocio est√° cerrado en esta fecha.</p>';
                    return;
                }

                // For daily availability, we need ALL appointments for that day, not just the barber's weekly ones.
                 const q = query(collection(db, "appointments"), where("date", "==", dateString));
                 const querySnapshot = await getDocs(q);
                 const dailyAppointments = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));


                let availabilityHtml = '';

                const barbersToShow = barberFilter === 'all' 
                    ? config.barbers.filter(b => schedule.workingBarbers.includes(b.id)) 
                    : config.barbers.filter(b => b.id === barberFilter && schedule.workingBarbers.includes(b.id));

                if (barbersToShow.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">No hay barberos asignados para este d√≠a.</p>';
                    return;
                }

                barbersToShow.forEach(barber => {
                    availabilityHtml += `<div class="p-4 bg-gray-50 rounded-lg shadow-sm mt-2">`;
                    availabilityHtml += `<h4 class="font-semibold text-lg text-custom-foreground">${barber.name}</h4>`;

                    const barberAppointments = dailyAppointments.filter(appt => appt.barberId === barber.id);
                    const bookedSlots = new Set();
                    barberAppointments.forEach(appt => {
                        const serviceInfo = config.services.find(s => s.id === appt.serviceId) || { durationSlots: 1 };
                        for (let i = 0; i < serviceInfo.durationSlots; i++) {
                            bookedSlots.add(utils.addMinutesToTime(appt.time, i * 30));
                        }
                    });

                    const availableSlots = [];
                    // --- CORRECTED TIME SLOT GENERATION LOGIC ---
                    const [startHour, startMinute] = schedule.start.split(':').map(Number);
                    const [endHour, endMinute] = schedule.end.split(':').map(Number);

                    for (let h = startHour; h <= endHour; h++) {
                        const mStart = (h === startHour) ? startMinute : 0;
                        const mEnd = (h === endHour) ? endMinute : 60;

                        for (let m = mStart; m < mEnd; m += 30) {
                            const timeSlot = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                            if (!bookedSlots.has(timeSlot)) {
                                availableSlots.push(timeSlot);
                            }
                        }
                    }

                    if (availableSlots.length > 0) {
                        availabilityHtml += '<div class="grid grid-cols-3 sm:grid-cols-4 gap-2 mt-2">';
                        availableSlots.forEach(slot => {
                            availabilityHtml += `<span class="bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded-full text-center">${utils.formatTime12Hour(slot)}</span>`;
                        });
                        availabilityHtml += '</div>';
                    } else {
                        availabilityHtml += '<p class="text-gray-500 mt-2 text-sm">No hay horarios libres para este d√≠a.</p>';
                    }
                    availabilityHtml += `</div>`;
                });

                container.innerHTML = availabilityHtml;
            },
            async barberCards(date) {
                const container = dom.barberCardsContainer;
                container.innerHTML = '';

                if (!date) {
                    container.innerHTML = '<p class="text-gray-500">Por favor, selecciona una fecha primero.</p>';
                    return;
                }

                const schedule = utils.getScheduleForDate(utils.getLocalDateString(date));

                if (!schedule.isOpen || schedule.workingBarbers.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No hay barberos disponibles en esta fecha.</p>';
                    return;
                }

                const availableBarbers = config.barbers.filter(barber => schedule.workingBarbers.includes(barber.id));
                
                availableBarbers.forEach(barber => {
                    const card = document.createElement('div');
                    card.id = `barber-${barber.id}-card`;
                    card.dataset.barberId = barber.id;
                    card.dataset.barberName = barber.name;
                    card.className = 'p-4 rounded-lg cursor-pointer transition-colors shadow-md hover:shadow-lg bg-gray-100 hover:bg-gray-200 border-2 border-transparent';
                    if (state.selectedBarber && state.selectedBarber.id === barber.id) {
                        card.classList.add('active-selection');
                    }
                    card.innerHTML = `<p class="font-semibold">${barber.name}</p>`;
                    card.addEventListener('click', () => eventHandlers.selectBarber(barber));
                    container.appendChild(card);
                });
            },
            scheduleAdminButtons(status) {
                const openBtn = dom.setDayOpenButton;
                const closedBtn = dom.setDayClosedButton;
                const defaultBtn = dom.setDayDefaultButton;
                
                [openBtn, closedBtn, defaultBtn].forEach(btn => {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
                });

                if (status === true) {
                    openBtn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                } else if (status === false) {
                    closedBtn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                } else {
                    defaultBtn.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                }
            }
        };

        // --- Event Handlers ---
        const eventHandlers = {
            handlePopState(event) {
                const newView = event.state ? event.state.view : 'serviceSelection';
                utils.showView(newView, false);
            },
            prevMonth() {
                state.calendar.month = (state.calendar.month === 0) ? 11 : state.calendar.month - 1;
                if (state.calendar.month === 11) state.calendar.year--;
                state.selectedDate = null;
                render.calendar();
                render.barberCards(null);
                render.timeSlots();
            },
            nextMonth() {
                state.calendar.month = (state.calendar.month === 11) ? 0 : state.calendar.month + 1;
                if (state.calendar.month === 0) state.calendar.year++;
                state.selectedDate = null;
                render.calendar();
                render.barberCards(null);
                render.timeSlots();
            },
            async selectDay(e) {
                const dayDiv = e.currentTarget;
                const selectedISO = dayDiv.dataset.day;
                if (new Date(selectedISO) < new Date().setHours(0, 0, 0, 0)) return;
                
                state.selectedDate = new Date(selectedISO);
                state.selectedTime = null;
                state.selectedBarber = null;

                render.calendar();
                await render.barberCards(state.selectedDate);
                render.timeSlots();
            },
             selectBarber(barber) {
                state.selectedBarber = barber;
                state.selectedTime = null;
                render.barberCards(state.selectedDate);
                if (state.selectedDate) {
                    firebase.setupClientAppointmentsListener(barber.id, utils.getLocalDateString(state.selectedDate));
                }
            },
            async confirmAppointment() {
                const clientPhone = utils.cleanPhoneNumber(dom.clientPhoneInput.value);
                if (!dom.clientNameInput.value || !clientPhone || !state.selectedService || !state.selectedBarber || !state.selectedDate || !state.selectedTime) {
                    return utils.showModal("Por favor, completa todos los campos para agendar.");
                }
                if (!utils.validateMexicanPhoneNumber(clientPhone)) {
                    return utils.showModal("Por favor, el numero escrito no existe. Intentelo de nuevo con otro numero.");
                }

                const appointmentData = {
                    serviceId: state.selectedService.id,
                    barberId: state.selectedBarber.id,
                    date: utils.getLocalDateString(state.selectedDate),
                    time: state.selectedTime,
                    clientName: dom.clientNameInput.value,
                    clientPhone: clientPhone,
                    userId: state.userId,
                    createdAt: serverTimestamp(),
                    status: 'confirmed'
                };

                try {
                    await addDoc(collection(db, "appointments"), appointmentData);
                    utils.showModal("¬°Tu cita ha sido confirmada! Se abrir√° WhatsApp para que notifiques al negocio.", () => {
                        const businessMessage = `Nueva cita agendada:\n\nNombre: ${appointmentData.clientName}\nServicio: ${state.selectedService.name}\nBarbero: ${state.selectedBarber.name}\nFecha: ${appointmentData.date}\nHora: ${utils.formatTime12Hour(appointmentData.time)}`;
                        const businessWhatsappUrl = `https://wa.me/${config.businessPhoneNumber}?text=${encodeURIComponent(businessMessage)}`;
                        window.open(businessWhatsappUrl, '_blank');
                        utils.resetAppointmentForm();
                        utils.showView('serviceSelection');
                    });
                } catch (error) {
                    utils.showModal(`Error al agendar: ${error.message}`);
                }
            },
            editAppointment(e) {
                const apptId = e.target.dataset.apptId;
                state.appointmentToProcess = state.dashboardAppointments.find(appt => appt.id === apptId);
                if (state.appointmentToProcess) {
                    dom.editingClientNameSpan.textContent = state.appointmentToProcess.clientName;
                    dom.editDateInput.value = state.appointmentToProcess.date;
                    dom.editTimeInput.value = state.appointmentToProcess.time;
                    dom.editBarberSelect.innerHTML = config.barbers.map(b => `<option value="${b.id}" ${b.id === state.appointmentToProcess.barberId ? 'selected' : ''}>${b.name}</option>`).join('');
                    dom.editAppointmentModal.classList.remove('hidden');
                }
            },
            deleteAppointment(e) {
                const apptId = e.target.dataset.apptId;
                const appointmentToDelete = state.dashboardAppointments.find(appt => appt.id === apptId);
                if (!appointmentToDelete) return utils.showModal("No se pudo encontrar la cita.");

                const message = `Hola ${appointmentToDelete.clientName}, te informamos que tu cita en Villanos Barber√≠a ha sido cancelada. Para cualquier aclaraci√≥n, no dudes en contactarnos.`;
                const whatsappUrl = `https://wa.me/${utils.formatPhoneNumberForWhatsApp(appointmentToDelete.clientPhone)}?text=${encodeURIComponent(message)}`;

                utils.showModal("¬øSeguro que quieres cancelar esta cita? Se enviar√° una notificaci√≥n por WhatsApp al cliente.", async () => {
                    try {
                        await deleteDoc(doc(db, "appointments", apptId));
                        window.open(whatsappUrl, '_blank');
                        utils.showModal("Cita cancelada con √©xito y notificaci√≥n enviada.");
                    } catch (error) {
                        utils.showModal(`Error al cancelar cita: ${error.message}`);
                    }
                });
            },
            attendAppointment(e) {
                const apptId = e.target.dataset.apptId;
                state.appointmentToProcess = state.dashboardAppointments.find(appt => appt.id === apptId);
                if (state.appointmentToProcess) {
                    dom.paymentClientNameSpan.textContent = state.appointmentToProcess.clientName;
                    dom.paymentMethodModal.classList.remove('hidden');
                }
            },
            async notifyClient(e) {
                const apptId = e.target.dataset.apptId;
                const appointment = state.dashboardAppointments.find(appt => appt.id === apptId);
                if (!appointment) return utils.showModal("No se pudo encontrar la cita.");

                const prompt = `Eres un asistente de la barber√≠a "Villanos Barber√≠a & Tattoo". Escribe un recordatorio de cita amigable y profesional para un cliente. Incluye el nombre del cliente, la fecha y la hora de la cita en formato de 12 horas (ej. 2:30 PM). Aqu√≠ est√°n los detalles:\n\n- Nombre: ${appointment.clientName}\n- Fecha: ${appointment.date}\n- Hora: ${utils.formatTime12Hour(appointment.time)}\n\nEl mensaje debe ser corto, amigable y terminar con "¬°Te esperamos!".`;

                try {
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const text = result.candidates[0].content.parts[0].text;
                        const whatsappUrl = `https://wa.me/${utils.formatPhoneNumberForWhatsApp(appointment.clientPhone)}?text=${encodeURIComponent(text)}`;
                        window.open(whatsappUrl, '_blank');
                    } else {
                        throw new Error("Respuesta inesperada de la API de Gemini");
                    }
                } catch (error) {
                    console.error("Error con la API de Gemini:", error);
                    utils.showModal('Hubo un error al generar el mensaje. Por favor, int√©ntalo de nuevo.');
                }
            },
            async markAppointmentAsAttended(paymentMethod) {
                if (!state.appointmentToProcess) return;
                try {
                    await updateDoc(doc(db, "appointments", state.appointmentToProcess.id), {
                        status: 'attended',
                        paymentMethod: paymentMethod,
                        attendedAt: serverTimestamp()
                    });
                    dom.paymentMethodModal.classList.add('hidden');
                    utils.showModal('Cita marcada como atendida.');
                } catch (error) {
                    utils.showModal(`Error al actualizar la cita: ${error.message}`);
                }
            },
            async searchMyAppointments(e) {
                e.preventDefault();
                const name = dom.searchClientNameInput.value.trim();
                const phone = utils.cleanPhoneNumber(dom.searchClientPhoneInput.value);

                if (!name || !phone) {
                    return utils.showModal("Por favor, ingresa tu nombre y tel√©fono para buscar.");
                }
                if (!utils.validateMexicanPhoneNumber(phone)) {
                    return utils.showModal("Por favor, el numero escrito no existe. Intentelo de nuevo con otro numero.");
                }

                try {
                    const q = query(collection(db, "appointments"), where("clientPhone", "==", phone));
                    const querySnapshot = await getDocs(q);
                    const allAppointmentsForPhone = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    const appointments = allAppointmentsForPhone.filter(appt => 
                        appt.clientName.toLowerCase() === name.toLowerCase() &&
                        (appt.status === 'confirmed' || appt.status === 'pending')
                    );

                    render.clientAppointmentsResults(appointments);
                } catch (error) {
                    console.error("Error buscando citas:", error);
                    utils.showModal("Ocurri√≥ un error al buscar tus citas.");
                }
            },
            clientCancelAppointment(e) {
                const apptId = e.target.dataset.apptId;
                utils.showModal("¬øEst√°s seguro de que quieres cancelar tu cita? Esta acci√≥n no se puede deshacer.", async () => {
                    try {
                        await deleteDoc(doc(db, "appointments", apptId));
                        utils.showModal("Tu cita ha sido cancelada con √©xito.", () => {
                            dom.searchMyAppointmentsForm.dispatchEvent(new Event('submit'));
                        });
                    } catch (error) {
                        console.error("Error cancelando cita:", error);
                        utils.showModal("No se pudo cancelar la cita. Int√©ntalo de nuevo.");
                    }
                });
            },
            clientMoveAppointmentSetup(e, appointments) {
                const apptId = e.target.dataset.apptId;
                const appointment = appointments.find(a => a.id === apptId);
                if (!appointment) return;

                state.moveAppointmentData.originalAppointment = appointment;
                state.moveAppointmentData.newDate = null;
                state.moveAppointmentData.newTime = null;
                state.moveAppointmentData.newBarberId = appointment.barberId;

                const service = config.services.find(s => s.id === appointment.serviceId);
                const barber = config.barbers.find(b => b.id === appointment.barberId);

                dom.moveAppointmentSummary.innerHTML = `
                    <p>Est√°s moviendo tu cita de <strong>${service.name}</strong>.</p>
                    <p class="text-sm text-gray-600">Originalmente con ${barber.name} el ${appointment.date} a las ${utils.formatTime12Hour(appointment.time)}</p>
                `;
                
                dom.moveBarberSelect.innerHTML = config.barbers.map(b => `<option value="${b.id}" ${b.id === appointment.barberId ? 'selected' : ''}>${b.name}</option>`).join('');
                
                firebase.setupClientAppointmentsListener(appointment.barberId, null);

                render.moveCalendar();
                render.moveTimeSlots();
                utils.showView('moveAppointment');
            },
            movePrevMonth() {
                const calState = state.moveAppointmentData.calendar;
                calState.month = (calState.month === 0) ? 11 : calState.month - 1;
                if (calState.month === 11) calState.year--;
                state.moveAppointmentData.newDate = null;
                render.moveCalendar();
                render.moveTimeSlots();
            },
            moveNextMonth() {
                const calState = state.moveAppointmentData.calendar;
                calState.month = (calState.month === 11) ? 0 : calState.month + 1;
                if (calState.month === 0) calState.year++;
                state.moveAppointmentData.newDate = null;
                render.moveCalendar();
                render.moveTimeSlots();
            },
            moveSelectDay(e) {
                const dayDiv = e.currentTarget;
                if (new Date(dayDiv.dataset.day) < new Date().setHours(0, 0, 0, 0)) return;
                state.moveAppointmentData.newDate = new Date(dayDiv.dataset.day);
                state.moveAppointmentData.newTime = null;
                render.moveCalendar();
                firebase.setupClientAppointmentsListener(state.moveAppointmentData.newBarberId, utils.getLocalDateString(state.moveAppointmentData.newDate));
            },
            async confirmMoveAppointment() {
                const { originalAppointment, newDate, newTime, newBarberId } = state.moveAppointmentData;
                if (!originalAppointment || !newDate || !newTime || !newBarberId) {
                    return utils.showModal("Por favor, selecciona un barbero, una nueva fecha y hora para tu cita.");
                }

                try {
                    const newDateString = utils.getLocalDateString(newDate);
                    await updateDoc(doc(db, "appointments", originalAppointment.id), {
                        date: newDateString,
                        time: newTime,
                        barberId: newBarberId,
                        status: 'confirmed'
                    });
                    utils.showModal("¬°Tu cita se ha movido con √©xito! Se abrir√° WhatsApp para notificar al negocio del cambio.", () => {
                        const newBarber = config.barbers.find(b => b.id === newBarberId);
                        const businessMessage = `AVISO: Un cliente ha movido su cita:\n\nNombre: ${originalAppointment.clientName}\nNuevo Barbero: ${newBarber.name}\nNueva Fecha: ${newDateString}\nNueva Hora: ${utils.formatTime12Hour(newTime)}`;
                        const businessWhatsappUrl = `https://wa.me/${config.businessPhoneNumber}?text=${encodeURIComponent(businessMessage)}`;
                        window.open(businessWhatsappUrl, '_blank');
                        utils.showView('serviceSelection');
                    });
                } catch (error) {
                    console.error("Error moviendo la cita:", error);
                    utils.showModal("No se pudo mover la cita. Por favor, int√©ntalo de nuevo.");
                }
            },
            handleMoveBarberChange(e) {
                const newBarberId = e.target.value;
                state.moveAppointmentData.newBarberId = newBarberId;
                state.moveAppointmentData.newDate = null;
                state.moveAppointmentData.newTime = null;
                
                state.clientAppointments = [];
                
                render.moveCalendar();
                render.moveTimeSlots();
            },
            async adminUpdateAppointment() {
                if (!state.appointmentToProcess) return;
                const newDate = dom.editDateInput.value;
                const newTime = dom.editTimeInput.value;
                const newBarberId = dom.editBarberSelect.value;

                if (!newDate || !newTime || !newBarberId) {
                    return utils.showModal("Por favor, completa todos los campos para mover la cita.");
                }

                try {
                    await updateDoc(doc(db, "appointments", state.appointmentToProcess.id), {
                        date: newDate,
                        time: newTime,
                        barberId: newBarberId
                    });

                    const newBarber = config.barbers.find(b => b.id === newBarberId);
                    const message = `Hola ${state.appointmentToProcess.clientName}, tu cita en Villanos Barber√≠a ha sido reagendada con ${newBarber.name} para el d√≠a ${newDate} a las ${utils.formatTime12Hour(newTime)}. ¬°Te esperamos!`;
                    const whatsappUrl = `https://wa.me/${utils.formatPhoneNumberForWhatsApp(state.appointmentToProcess.clientPhone)}?text=${encodeURIComponent(message)}`;
                    
                    window.open(whatsappUrl, '_blank');
                    
                    utils.showModal("Cita actualizada con √©xito. Se abri√≥ WhatsApp para notificar al cliente.", () => {
                        dom.editAppointmentModal.classList.add('hidden');
                    });
                } catch (error) {
                    utils.showModal(`Error al actualizar cita: ${error.message}`);
                }
            },
            displayAdminAvailability() {
                render.dailyAvailability(dom.adminAvailabilityDateInput.value, dom.adminAvailabilityContainer, 'all');
            },
            displayBarberAvailability() {
                render.dailyAvailability(dom.barberAvailabilityDateInput.value, dom.barberAvailabilityContainer, state.loggedInBarberId);
            },
            async handleScheduleDateChange() {
                const dateString = dom.scheduleDateInput.value;
                if (!dateString) {
                    dom.scheduleSettingsContainer.classList.add('hidden');
                    return;
                }

                const schedule = utils.getScheduleForDate(dateString);
                
                const docSnap = await getDoc(doc(db, "schedule_overrides", dateString));
                if (docSnap.exists()) {
                     state.tempScheduleStatus = docSnap.data().isOpen;
                } else {
                    state.tempScheduleStatus = undefined;
                }

                render.scheduleAdminButtons(state.tempScheduleStatus);

                dom.scheduleStartTimeInput.value = schedule.start;
                dom.scheduleEndTimeInput.value = schedule.end;
                
                const barbersCheckboxes = dom.scheduleBarbersCheckboxes;
                barbersCheckboxes.innerHTML = '';
                config.barbers.forEach(barber => {
                    const isChecked = schedule.workingBarbers.includes(barber.id);
                    barbersCheckboxes.innerHTML += `
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" value="${barber.id}" class="rounded border-gray-300" ${isChecked ? 'checked' : ''}>
                            <span>${barber.name}</span>
                        </label>
                    `;
                });

                dom.scheduleSettingsContainer.classList.remove('hidden');
            },
            async handleAbsenceDateChange() {
                const dateString = dom.absenceDateInput.value;
                if (!dateString) {
                    dom.absenceBarbersCheckboxes.innerHTML = '';
                    return;
                }
                
                const schedule = utils.getScheduleForDate(dateString);
                
                const barbersCheckboxes = dom.absenceBarbersCheckboxes;
                barbersCheckboxes.innerHTML = '';
                config.barbers.forEach(barber => {
                    const isWorking = schedule.workingBarbers.includes(barber.id);
                    barbersCheckboxes.innerHTML += `
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" value="${barber.id}" class="rounded border-gray-300" ${!isWorking ? 'checked' : ''}>
                            <span>${barber.name} (Ausente)</span>
                        </label>
                    `;
                });
            },
            async saveAbsences() {
                const dateString = dom.absenceDateInput.value;
                if (!dateString) {
                    return utils.showModal("Por favor, selecciona una fecha para gestionar las ausencias.");
                }

                const absentBarberIds = Array.from(dom.absenceBarbersCheckboxes.querySelectorAll('input:checked')).map(input => input.value);
                
                const currentEffectiveSchedule = utils.getScheduleForDate(dateString); 
                
                const workingBarbers = config.barbers
                    .map(b => b.id)
                    .filter(id => !absentBarberIds.includes(id));
                    
                const overrideData = {
                    startTime: currentEffectiveSchedule.start,
                    endTime: currentEffectiveSchedule.end,
                    isOpen: currentEffectiveSchedule.isOpen && workingBarbers.length > 0,
                    workingBarbers: workingBarbers,
                };

                try {
                    await setDoc(doc(db, "schedule_overrides", dateString), overrideData);
                    // No need to set cache here, the listener will do it.
                    utils.showModal(`Ausencias para el d√≠a ${dateString} guardadas con √©xito.`);
                    // Manually refresh the view to show the change immediately
                    await eventHandlers.handleAbsenceDateChange();

                } catch (error) {
                    console.error("Error saving absences:", error);
                    utils.showModal("No se pudo guardar la configuraci√≥n de ausencias.");
                }
            },
            async saveScheduleOverride() {
                const dateString = dom.scheduleDateInput.value;
                if (!dateString) {
                    return utils.showModal("Por favor, selecciona una fecha para configurar.");
                }

                if (state.tempScheduleStatus === undefined) {
                    try {
                        await deleteDoc(doc(db, "schedule_overrides", dateString));
                        // No need to delete from cache, listener will handle it.
                        utils.showModal("La configuraci√≥n para el " + dateString + " ha sido restaurada a los valores por defecto.");
                    } catch (error) {
                        if (error.code !== 'not-found') {
                           console.error("Error deleting schedule override:", error);
                           utils.showModal("No se pudo restaurar la configuraci√≥n.");
                        } else {
                           utils.showModal("La configuraci√≥n ya era la predeterminada.");
                        }
                    }
                     // Manually refresh to show the change
                    await eventHandlers.handleScheduleDateChange();
                    return;
                }

                const workingBarbers = Array.from(dom.scheduleBarbersCheckboxes.querySelectorAll('input:checked')).map(input => input.value);
                
                const intendedOpenState = state.tempScheduleStatus;
                const finalOpenState = intendedOpenState && workingBarbers.length > 0;

                const overrideData = {
                    startTime: dom.scheduleStartTimeInput.value,
                    endTime: dom.scheduleEndTimeInput.value,
                    workingBarbers: workingBarbers,
                    isOpen: finalOpenState
                };

                try {
                    await setDoc(doc(db, "schedule_overrides", dateString), overrideData); 
                    // No need to set cache here, listener will handle it.
                    utils.showModal("Configuraci√≥n de horario guardada con √©xito para el " + dateString);
                    // Manually refresh to show the change
                    await eventHandlers.handleScheduleDateChange();

                } catch (error) {
                    console.error("Error saving schedule override:", error);
                    utils.showModal("No se pudo guardar la configuraci√≥n.");
                }
            },
            async updateGeneralSettings() {
                const isEnabled = dom.barberContactToggle.checked;
                try {
                    await setDoc(doc(db, "settings", "general"), {
                        allowBarberContactView: isEnabled
                    });
                    utils.showModal("Configuraci√≥n guardada correctamente.");
                } catch (error) {
                    console.error("Error updating general settings:", error);
                    utils.showModal("No se pudo guardar la configuraci√≥n.");
                    // Revert UI on error
                    dom.barberContactToggle.checked = !isEnabled;
                }
            },
            renderCurrentDashboard() {
                if (state.userRole === 'admin' && state.currentView === 'adminDashboard') {
                    render.dashboardAppointmentsTable(dom.allAppointmentsTableContainer, state.dashboardAppointments, dom.apptCountSpan);
                    render.dailyReports();
                    eventHandlers.displayAdminAvailability();
                } else if (state.userRole === 'barber' && state.currentView === 'barberDashboard') {
                    render.dashboardAppointmentsTable(dom.barberAppointmentsTableContainer, state.dashboardAppointments, dom.barberApptCountSpan);
                    eventHandlers.displayBarberAvailability();
                }
            }
        };

        // --- Firebase Functions ---
        const firebase = {
            initialize() {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            },
            handleAuth() {
                onAuthStateChanged(auth, async (user) => {
                    // Always tear down old listeners on any auth change
                    if (state.unsubscribe.dashboard) state.unsubscribe.dashboard();
                    if (state.unsubscribe.settings) state.unsubscribe.settings();
                    if (state.unsubscribe.schedule) state.unsubscribe.schedule();


                    if (user) {
                        state.currentUser = user;
                        state.userId = user.uid;

                        // Start the unified schedule listener for ALL users (anonymous or logged in)
                        firebase.setupScheduleOverridesListener();

                        if (!user.isAnonymous) {
                            const userEmail = user.email;
                            if (userEmail === config.roles.admin) {
                                state.userRole = 'admin';
                            } else if (userEmail === config.roles.edher) {
                                state.userRole = 'barber';
                                state.loggedInBarberId = 'edher';
                            } else if (userEmail === config.roles.tavo) {
                                state.userRole = 'barber';
                                state.loggedInBarberId = 'tavo';
                            } else {
                                state.userRole = 'customer';
                            }

                            dom.userDisplayNameSpan.textContent = `Hola, ${user.displayName || user.email.split('@')[0]}`;
                            dom.userInfoDiv.classList.remove('hidden');
                            dom.authToggleButton.classList.add('hidden');
                            dom.clientNameInput.value = user.displayName || '';
                            dom.adminDashboardButton.style.display = state.userRole === 'admin' ? 'block' : 'none';
                            dom.barberDashboardButton.style.display = state.userRole === 'barber' ? 'block' : 'none';
                            
                            const providerId = user.providerData[0]?.providerId;
                            dom.changePasswordButton.style.display = (providerId === 'password') ? 'block' : 'none';

                            await firebase.setupGeneralSettingsListener();
                            firebase.setupDashboardAppointmentsListener();

                            if (state.userRole === 'admin') {
                                utils.showView('adminDashboard', false);
                            } else if (state.userRole === 'barber') {
                                utils.showView('barberDashboard', false);
                            }
                        } else {
                            state.userRole = 'customer';
                            state.loggedInBarberId = null;
                            dom.userInfoDiv.classList.add('hidden');
                            dom.authToggleButton.classList.remove('hidden');
                            dom.adminDashboardButton.style.display = 'none';
                            dom.barberDashboardButton.style.display = 'none';
                            chatbot.startConversation();
                        }
                    } else {
                        try {
                            await setPersistence(auth, browserSessionPersistence);
                            await signInAnonymously(auth);
                        } catch (err) {
                            console.error("Error during anonymous sign-in:", err);
                            utils.showModal("Error de conexi√≥n. Por favor, recarga la p√°gina.");
                        }
                    }
                });
            },
            handleGoogleCredentialResponse(response) {
                try {
                    const idToken = response.credential;
                    const credential = GoogleAuthProvider.credential(idToken);
                    
                    signInWithCredential(auth, credential)
                        .then(() => {
                            utils.showModal("¬°Inicio de sesi√≥n con Google exitoso!", () => {
                                if (state.userRole === 'customer') {
                                   utils.showView('serviceSelection');
                                }
                            });
                        })
                        .catch((error) => {
                            console.error("Error signing in with Firebase credential:", error);
                            utils.showModal("Ocurri√≥ un error al verificar la cuenta de Google.");
                        });
                } catch (error) {
                    console.error("Error handling Google credential response:", error);
                    utils.showModal("Ocurri√≥ un error al procesar la respuesta de Google.");
                }
            },
            async handleChangePassword() {
                const currentPassword = dom.currentPasswordInput.value;
                const newPassword = dom.newPasswordInput.value;
                const confirmNewPassword = dom.confirmNewPasswordInput.value;

                if (!currentPassword || !newPassword || !confirmNewPassword) return utils.showModal("Por favor, completa todos los campos.");
                if (newPassword.length < 6) return utils.showModal("La nueva contrase√±a debe tener al menos 6 caracteres.");
                if (newPassword !== confirmNewPassword) return utils.showModal("Las nuevas contrase√±as no coinciden.");
                
                const user = auth.currentUser;
                if (!user || !user.email) return utils.showModal("No se pudo encontrar el usuario actual. Por favor, inicia sesi√≥n de nuevo.");

                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                reauthenticateWithCredential(user, credential).then(() => {
                    updatePassword(user, newPassword).then(() => {
                        utils.showModal("¬°Contrase√±a actualizada con √©xito!", () => {
                            dom.currentPasswordInput.value = '';
                            dom.newPasswordInput.value = '';
                            dom.confirmNewPasswordInput.value = '';
                            history.back();
                        });
                    }).catch((error) => utils.showModal(`Error al actualizar la contrase√±a: ${error.message}`));
                }).catch((error) => {
                    if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        utils.showModal("La contrase√±a actual es incorrecta.");
                    } else {
                        utils.showModal(`Error de autenticaci√≥n: ${error.message}`);
                    }
                });
            },
            async handleForgotPassword() {
                const email = dom.resetEmailInput.value;
                if (!email) return utils.showModal("Por favor, ingresa tu correo electr√≥nico.");
                
                try {
                    await sendPasswordResetEmail(auth, email);
                    utils.showModal("Se ha enviado un enlace para restablecer tu contrase√±a a tu correo.", () => utils.showView('login'));
                } catch (error) {
                    utils.showModal(error.code === 'auth/user-not-found' ? "No se encontr√≥ ninguna cuenta con ese correo electr√≥nico." : `Error: ${error.message}`);
                }
            },
            setupClientAppointmentsListener(barberId, dateString) {
                if (state.unsubscribe.client) state.unsubscribe.client();
                
                if (!barberId || !dateString) {
                    state.clientAppointments = [];
                    if (state.currentView === 'barberAppointment') render.timeSlots();
                    if (state.currentView === 'moveAppointment') render.moveTimeSlots();
                    return;
                }

                const q = query(collection(db, "appointments"), where("barberId", "==", barberId), where("date", "==", dateString));
                state.unsubscribe.client = onSnapshot(q, (snapshot) => {
                    state.clientAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (state.currentView === 'barberAppointment') render.timeSlots();
                    if (state.currentView === 'moveAppointment') render.moveTimeSlots();
                }, (error) => console.error("Error listening to client appointments:", error));
            },
            setupDashboardAppointmentsListener() {
                if (state.userRole !== 'admin' && state.userRole !== 'barber') return;
                if (state.unsubscribe.dashboard) state.unsubscribe.dashboard();

                let q;
                if (state.userRole === 'admin') {
                    q = query(collection(db, "appointments"));
                } else { // Barber role
                    const weekRange = utils.getWeekRange();
                    dom.barberWeekRange.textContent = `Mostrando: ${weekRange.start} al ${weekRange.end}`;
                    q = query(collection(db, "appointments"),
                        where("barberId", "==", state.loggedInBarberId)
                    );
                }

                state.unsubscribe.dashboard = onSnapshot(q, (snapshot) => {
                    const allAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    if (state.userRole === 'barber') {
                        const weekRange = utils.getWeekRange();
                        state.dashboardAppointments = allAppointments.filter(appt => 
                            appt.date >= weekRange.start && appt.date <= weekRange.end
                        );
                    } else {
                        state.dashboardAppointments = allAppointments;
                    }
                    
                    eventHandlers.renderCurrentDashboard();
                }, (error) => console.error("Error listening to dashboard appointments:", error));
            },
            async setupGeneralSettingsListener() {
                if (state.unsubscribe.settings) state.unsubscribe.settings();
                return new Promise((resolve) => {
                    let isFirstRun = true;
                    state.unsubscribe.settings = onSnapshot(doc(db, "settings", "general"), (docSnap) => {
                        const newPermission = docSnap.exists() && docSnap.data().allowBarberContactView === true;
                        state.generalSettings.allowBarberContactView = newPermission;
                        if (state.userRole === 'admin') dom.barberContactToggle.checked = newPermission;
                        eventHandlers.renderCurrentDashboard();
                        if (isFirstRun) { isFirstRun = false; resolve(); }
                    }, (error) => {
                        console.error("Error listening to general settings:", error);
                        state.generalSettings.allowBarberContactView = false;
                        eventHandlers.renderCurrentDashboard();
                        if (isFirstRun) { isFirstRun = false; resolve(); }
                    });
                });
            },
            // This new listener keeps the local schedule cache in sync with Firestore for ALL users.
            setupScheduleOverridesListener() {
                if (state.unsubscribe.schedule) state.unsubscribe.schedule();

                const q = query(collection(db, "schedule_overrides"));
                state.unsubscribe.schedule = onSnapshot(q, (snapshot) => {
                    console.log("Schedule overrides updated from Firestore.");
                    state.scheduleOverrides.clear(); // Clear the old cache
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const schedule = {
                            isOpen: data.isOpen,
                            start: data.startTime,
                            end: data.endTime,
                            workingBarbers: data.workingBarbers
                        };
                        state.scheduleOverrides.set(doc.id, schedule);
                    });
                    // After updating the cache, re-render any view that depends on schedules.
                    if (state.currentView === 'barberAppointment') {
                        render.barberCards(state.selectedDate);
                        render.timeSlots();
                    } else if (state.currentView === 'adminDashboard') {
                         eventHandlers.handleScheduleDateChange();
                         eventHandlers.handleAbsenceDateChange();
                    }
                }, (error) => {
                    console.error("Failed to listen to schedule overrides:", error);
                    // If the listener fails (e.g., permissions), we clear the cache
                    // to ensure the app falls back to default business hours.
                    state.scheduleOverrides.clear();
                });
            }
        };

        // --- Chatbot Functions ---
        const chatbot = {
            toggle() {
                const windowEl = dom.chatbot.window;
                const isHidden = windowEl.style.display === 'none';
                
                if (isHidden) {
                    windowEl.style.display = 'flex';
                    dom.chatbot.icon.className = 'fas fa-times';
                } else {
                    windowEl.style.display = 'none';
                    dom.chatbot.icon.className = 'fas fa-comments';
                }
            },
            addMessage(text, sender, options = []) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                const textBubble = document.createElement('div');
                textBubble.className = 'text-bubble';
                textBubble.innerHTML = text;
                messageDiv.appendChild(textBubble);
                dom.chatbot.messages.appendChild(messageDiv);
                dom.chatbot.messages.scrollTop = dom.chatbot.messages.scrollHeight;
                chatbot.renderOptions(options);
            },
            renderOptions(options) {
                dom.chatbot.optionsContainer.innerHTML = '';
                dom.chatbot.inputForm.classList.toggle('hidden', options.length > 0);
                if (options.length > 0) {
                    options.forEach(option => {
                        const button = document.createElement('button');
                        button.className = 'option-button';
                        button.textContent = option.label;
                        button.onclick = () => chatbot.handleUserInput(option.value, option.label);
                        dom.chatbot.optionsContainer.appendChild(button);
                    });
                } else {
                    dom.chatbot.userInput.focus();
                }
            },
            startConversation() {
                state.chatbot.conversationState = 'initial';
                state.chatbot.userData = {};
                chatbot.addMessage('¬°Hola! Soy el asistente de Villanos. ¬øC√≥mo puedo ayudarte hoy?', 'bot', [
                    { label: 'Agendar una cita', value: 'agendar' },
                    { label: 'Ver mis citas', value: 'ver_citas' }
                ]);
            },
            async handleUserInput(value, label) {
                if (label) {
                    chatbot.addMessage(label, 'user');
                } else {
                    chatbot.addMessage(value, 'user');
                }

                switch (state.chatbot.conversationState) {
                    case 'initial':
                        if (value === 'agendar') {
                            state.chatbot.conversationState = 'ask_service';
                            chatbot.addMessage('¬°Claro! ¬øQu√© servicio te gustar√≠a agendar?', 'bot', config.services.filter(s => s.price > 0).map(s => ({ label: s.name, value: s.id })));
                        } else if (value === 'ver_citas') {
                            state.chatbot.conversationState = 'ask_name_for_search';
                            chatbot.addMessage('Perfecto. Para encontrar tus citas, primero dime tu nombre completo.', 'bot');
                        } else if (value === 'end') {
                            chatbot.startConversation();
                        }
                        break;
                    
                    case 'ask_name_for_search':
                        state.chatbot.userData.name = value;
                        state.chatbot.conversationState = 'ask_phone_for_search';
                        chatbot.addMessage(`Gracias, ${value}. Ahora, por favor, escribe tu n√∫mero de tel√©fono (10 d√≠gitos).`, 'bot');
                        break;

                    case 'ask_service':
                        state.chatbot.userData.serviceId = value;
                        state.chatbot.conversationState = 'ask_date_chatbot';
                        chatbot.addMessage('Excelente elecci√≥n. Ahora, por favor, dime qu√© d√≠a te gustar√≠a tu cita (ej. "hoy", "ma√±ana" o "dd/mm/aaaa").', 'bot');
                        break;
                    
                    case 'ask_date_chatbot':
                        const date = chatbot.parseDate(value);
                        if (!date) {
                            chatbot.addMessage('No entend√≠ la fecha. Por favor, usa un formato como "hoy", "ma√±ana" o "25/12/2025".', 'bot');
                            break;
                        }
                        state.chatbot.userData.date = date;
                        const schedule = utils.getScheduleForDate(utils.getLocalDateString(date));
                        if (!schedule.isOpen || schedule.workingBarbers.length === 0) {
                            chatbot.addMessage('Lo siento, el negocio est√° cerrado o no hay barberos disponibles ese d√≠a. Por favor, elige otra fecha.', 'bot');
                            break;
                        }
                        state.chatbot.conversationState = 'ask_barber';
                        const availableBarbers = config.barbers.filter(b => schedule.workingBarbers.includes(b.id));
                        chatbot.addMessage('Muy bien. ¬øCon qu√© barbero prefieres tu servicio?', 'bot', availableBarbers.map(b => ({ label: b.name, value: b.id })));
                        break;

                    case 'ask_barber':
                        state.chatbot.userData.barberId = value;
                        const availableSlots = await chatbot.getAvailableSlots(state.chatbot.userData.barberId, state.chatbot.userData.date, state.chatbot.userData.serviceId);
                        if (availableSlots.length === 0) {
                            chatbot.addMessage('Lo siento, no hay horarios disponibles para ese barbero. Por favor, elige otro barbero o fecha.', 'bot');
                            state.chatbot.conversationState = 'ask_date_chatbot';
                        } else {
                            state.chatbot.conversationState = 'ask_time';
                            chatbot.addMessage('Estos son los horarios disponibles. Por favor, elige uno:', 'bot', availableSlots.map(slot => ({ label: utils.formatTime12Hour(slot), value: slot })));
                        }
                        break;

                    case 'ask_time':
                        state.chatbot.userData.time = value;
                        state.chatbot.conversationState = 'ask_name';
                        chatbot.addMessage('¬°Perfecto! Ya casi terminamos. ¬øCu√°l es tu nombre completo?', 'bot');
                        break;

                    case 'ask_name':
                        state.chatbot.userData.name = value;
                        state.chatbot.conversationState = 'ask_phone';
                        chatbot.addMessage(`Gracias, ${state.chatbot.userData.name}. Ahora, por favor, escribe tu n√∫mero de tel√©fono (10 d√≠gitos) para confirmar.`, 'bot');
                        break;

                    case 'ask_phone':
                        if (!utils.validateMexicanPhoneNumber(value)) {
                            chatbot.addMessage('El n√∫mero no parece v√°lido. Por favor, aseg√∫rate de que sean 10 d√≠gitos con una LADA de M√©xico.', 'bot');
                            break;
                        }
                        state.chatbot.userData.phone = utils.cleanPhoneNumber(value);
                        await chatbot.scheduleAppointment();
                        break;

                    case 'ask_phone_for_search':
                         if (!utils.validateMexicanPhoneNumber(value)) {
                            chatbot.addMessage('El n√∫mero no parece v√°lido. Por favor, aseg√∫rate de que sean 10 d√≠gitos con una LADA de M√©xico.', 'bot');
                            break;
                        }
                        state.chatbot.userData.phone = utils.cleanPhoneNumber(value);
                        await chatbot.searchAppointments(state.chatbot.userData.name, state.chatbot.userData.phone);
                        break;
                    
                    case 'manage_appointment':
                        const [action, apptId] = value.split(':');
                        if (action === 'cancel') {
                            await chatbot.cancelAppointment(apptId);
                        } else if (action === 'move') {
                            const appointment = await chatbot.getAppointmentById(apptId);
                            if(appointment){
                                state.chatbot.userData = appointment;
                                state.chatbot.conversationState = 'ask_date_chatbot';
                                chatbot.addMessage('Entendido. Vamos a mover tu cita. Por favor, elige una nueva fecha (ej. "hoy", "ma√±ana" o "dd/mm/aaaa").', 'bot');
                            }
                        } else if (action === 'end') {
                            chatbot.startConversation();
                        }
                        break;
                }
            },
            async scheduleAppointment() {
                const { userData } = state.chatbot;
                const appointmentData = {
                    clientName: userData.name,
                    clientPhone: userData.phone,
                    serviceId: userData.serviceId,
                    barberId: userData.barberId,
                    date: utils.getLocalDateString(userData.date),
                    time: userData.time,
                    status: 'confirmed'
                };

                try {
                    if (userData.id) {
                         await updateDoc(doc(db, "appointments", userData.id), appointmentData);
                         chatbot.addMessage(`¬°Listo, ${userData.name}! Tu cita ha sido movida con √©xito para el <b>${chatbot.formatDate(userData.date)} a las ${utils.formatTime12Hour(userData.time)}</b>.`, 'bot');
                    } else {
                        await addDoc(collection(db, "appointments"), appointmentData);
                        chatbot.addMessage(`¬°Perfecto, ${userData.name}! Tu cita ha sido agendada para el <b>${chatbot.formatDate(userData.date)} a las ${utils.formatTime12Hour(userData.time)}</b>. ¬°Te esperamos!`, 'bot');
                    }
                    setTimeout(chatbot.startConversation, 3000);
                } catch (e) {
                    console.error("Error al agendar desde chatbot: ", e);
                    chatbot.addMessage('Lo siento, hubo un error al procesar tu cita. Por favor, int√©ntalo de nuevo.', 'bot');
                    setTimeout(chatbot.startConversation, 3000);
                }
            },
            async searchAppointments(name, phone) {
                try {
                    const q = query(collection(db, "appointments"), where("clientPhone", "==", phone));
                    const querySnapshot = await getDocs(q);
                    const appointmentsForPhone = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    const appointments = appointmentsForPhone.filter(appt => 
                        appt.clientName.toLowerCase() === name.toLowerCase() &&
                        (appt.status === 'confirmed' || appt.status === 'pending')
                    );

                    if (appointments.length === 0) {
                        chatbot.addMessage('No encontr√© citas activas con esos datos. ¬øDeseas agendar una nueva?', 'bot', [
                            { label: 'S√≠, agendar', value: 'agendar' },
                            { label: 'No, gracias', value: 'end' }
                        ]);
                        state.chatbot.conversationState = 'initial';
                    } else {
                        let messageText = 'Encontr√© estas citas a tu nombre:<br>';
                        appointments.forEach(appt => {
                            const service = config.services.find(s => s.id === appt.serviceId)?.name || 'Servicio';
                            messageText += `<br>- <b>${service}</b> el ${appt.date} a las ${utils.formatTime12Hour(appt.time)}`;
                        });
                        chatbot.addMessage(messageText, 'bot');
                        
                        const options = appointments.flatMap(appt => [
                            { label: `Mover cita del ${appt.date}`, value: `move:${appt.id}` },
                            { label: `Cancelar cita del ${appt.date}`, value: `cancel:${appt.id}` }
                        ]);
                        options.push({ label: 'No hacer cambios', value: 'end' });
                        
                        chatbot.addMessage('¬øQu√© te gustar√≠a hacer?', 'bot', options);
                        state.chatbot.conversationState = 'manage_appointment';
                    }
                } catch (e) {
                    console.error("Error buscando citas en chatbot:", e);
                    chatbot.addMessage('Hubo un problema al buscar tus citas. Int√©ntalo m√°s tarde.', 'bot');
                    setTimeout(chatbot.startConversation, 2000);
                }
            },
            async cancelAppointment(apptId) {
                try {
                    await deleteDoc(doc(db, "appointments", apptId));
                    chatbot.addMessage('Tu cita ha sido cancelada con √©xito.', 'bot');
                    setTimeout(chatbot.startConversation, 2000);
                } catch (e) {
                    console.error("Error cancelando cita en chatbot:", e);
                    chatbot.addMessage('No se pudo cancelar la cita. Por favor, int√©ntalo de nuevo.', 'bot');
                    setTimeout(chatbot.startConversation, 2000);
                }
            },
            async getAppointmentById(apptId) {
                try {
                    const docRef = doc(db, "appointments", apptId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        return { id: docSnap.id, ...docSnap.data() };
                    } else {
                        console.error("Chatbot: No such document!");
                        return null;
                    }
                } catch (error) {
                    console.error("Chatbot: Error getting document by ID:", error);
                    return null;
                }
            },
            async getAvailableSlots(barberId, date, serviceId) {
                const dateString = utils.getLocalDateString(date);
                const schedule = utils.getScheduleForDate(dateString);
                if (!schedule.isOpen) return [];

                try {
                    const q = query(collection(db, "appointments"), where("barberId", "==", barberId), where("date", "==", dateString));
                    const querySnapshot = await getDocs(q);
                    const bookedAppointments = querySnapshot.docs.map(doc => doc.data());
                    
                    const bookedSlots = new Set();
                    bookedAppointments.forEach(appt => {
                        const serviceInfo = config.services.find(s => s.id === appt.serviceId) || { durationSlots: 1 };
                        for (let i = 0; i < serviceInfo.durationSlots; i++) {
                            bookedSlots.add(utils.addMinutesToTime(appt.time, i * 30));
                        }
                    });

                    const availableSlots = [];
                    const serviceDurationSlots = config.services.find(s => s.id === serviceId)?.durationSlots || 1;
                    
                    // --- CORRECTED TIME SLOT GENERATION LOGIC ---
                    const [startHour, startMinute] = schedule.start.split(':').map(Number);
                    const [endHour, endMinute] = schedule.end.split(':').map(Number);
                    const scheduleEndTimeMinutes = (endHour * 60) + endMinute;

                    for (let h = startHour; h <= endHour; h++) {
                        const mStart = (h === startHour) ? startMinute : 0;
                        const mEnd = (h === endHour) ? endMinute : 60;
                        
                        for (let m = mStart; m < mEnd; m += 30) {
                            const timeSlot = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;

                            const potentialEndTimeMinutes = (h * 60 + m) + (serviceDurationSlots * 30);
                            if (potentialEndTimeMinutes > scheduleEndTimeMinutes) {
                                continue;
                            }

                            let isAvailable = true;
                            for (let i = 0; i < serviceDurationSlots; i++) {
                                const slotToVerify = utils.addMinutesToTime(timeSlot, i * 30);
                                if (bookedSlots.has(slotToVerify)) {
                                    isAvailable = false;
                                    break;
                                }
                            }
                            if (isAvailable) availableSlots.push(timeSlot);
                        }
                    }
                    return availableSlots;
                } catch (error) {
                    console.error("Chatbot: Error fetching appointments for slots:", error);
                    chatbot.addMessage("Tuve un problema al verificar los horarios. Por favor, intenta de nuevo.", "bot");
                    return [];
                }
            },
            parseDate(text) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (text.toLowerCase() === 'hoy') return today;
                if (text.toLowerCase() === 'ma√±ana') {
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return tomorrow;
                }
                const parts = text.match(/(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{4})/);
                if (parts) {
                    const day = parseInt(parts[1], 10);
                    const month = parseInt(parts[2], 10) - 1;
                    const year = parseInt(parts[3], 10);
                    const date = new Date(year, month, day);
                    if (date >= today) return date;
                }
                return null;
            },
            formatDate(date) {
                return date.toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
        };

        // --- Main Application Initialization ---
        function cacheDomElements() {
            dom.views = {
                serviceSelection: document.getElementById('service-selection-view'),
                barberAppointment: document.getElementById('barber-appointment-view'),
                shoeCleaning: document.getElementById('shoe-cleaning-view'),
                capCleaning: document.getElementById('cap-cleaning-view'),
                login: document.getElementById('login-view'),
                register: document.getElementById('register-view'),
                adminDashboard: document.getElementById('admin-dashboard-view'),
                barberDashboard: document.getElementById('barber-dashboard-view'),
                myAppointments: document.getElementById('my-appointments-view'),
                moveAppointment: document.getElementById('move-appointment-view'),
                changePassword: document.getElementById('change-password-view'),
                forgotPassword: document.getElementById('forgot-password-view'),
            };
            dom.authToggleButton = document.getElementById('auth-toggle-button');
            dom.userInfoDiv = document.getElementById('user-info');
            dom.userDisplayNameSpan = document.getElementById('user-display-name');
            dom.logoutButton = document.getElementById('logout-button');
            dom.adminDashboardButton = document.getElementById('admin-dashboard-button');
            dom.barberDashboardButton = document.getElementById('barber-dashboard-button');
            dom.changePasswordButton = document.getElementById('change-password-button');
            dom.barberServicesList = document.getElementById('barber-services-list');
            dom.clientNameInput = document.getElementById('client-name');
            dom.clientPhoneInput = document.getElementById('client-phone');
            dom.calendarContainer = document.getElementById('calendar-container');
            dom.timeSlotsContainer = document.getElementById('time-slots');
            dom.confirmAppointmentButton = document.getElementById('confirm-appointment-button');
            dom.loginEmailInput = document.getElementById('login-email');
            dom.loginPasswordInput = document.getElementById('login-password');
            dom.loginButton = document.getElementById('login-button');
            dom.googleLoginButtonContainer = document.getElementById('google-login-button-container');
            dom.rememberMeCheckbox = document.getElementById('remember-me');
            dom.registerNameInput = document.getElementById('register-name');
            dom.registerPhoneInput = document.getElementById('register-phone');
            dom.registerEmailInput = document.getElementById('register-email');
            dom.registerPasswordInput = document.getElementById('register-password');
            dom.registerButton = document.getElementById('register-button');
            dom.manualAddAppointmentForm = document.getElementById('manual-add-appointment-form');
            dom.manualClientNameInput = document.getElementById('manual-client-name');
            dom.manualClientPhoneInput = document.getElementById('manual-client-phone');
            dom.manualServiceSelect = document.getElementById('manual-service');
            dom.manualBarberSelect = document.getElementById('manual-barber');
            dom.manualDateInput = document.getElementById('manual-date');
            dom.manualTimeInput = document.getElementById('manual-time');
            dom.reportDateInput = document.getElementById('report-date');
            dom.dailyReportsContainer = document.getElementById('daily-reports-container');
            dom.allAppointmentsTableContainer = document.getElementById('all-appointments-table-container');
            dom.apptCountSpan = document.getElementById('appt-count');
            dom.editAppointmentModal = document.getElementById('edit-appointment-modal');
            dom.editingClientNameSpan = document.getElementById('editing-client-name');
            dom.editDateInput = document.getElementById('edit-date');
            dom.editTimeInput = document.getElementById('edit-time');
            dom.cancelEditButton = document.getElementById('cancel-edit-button');
            dom.updateAppointmentButton = document.getElementById('update-appointment-button');
            dom.editBarberSelect = document.getElementById('edit-barber-select');
            dom.barberManualAddForm = document.getElementById('barber-manual-add-form');
            dom.barberManualClientNameInput = document.getElementById('barber-manual-client-name');
            dom.barberManualClientPhoneInput = document.getElementById('barber-manual-client-phone');
            dom.barberManualServiceSelect = document.getElementById('barber-manual-service');
            dom.barberManualDateInput = document.getElementById('barber-manual-date');
            dom.barberManualTimeInput = document.getElementById('barber-manual-time');
            dom.barberApptCountSpan = document.getElementById('barber-appt-count');
            dom.barberAppointmentsTableContainer = document.getElementById('barber-appointments-table-container');
            dom.barberWeekRange = document.getElementById('barber-week-range');
            dom.globalModal = document.getElementById('global-modal');
            dom.modalMessageP = document.getElementById('modal-message');
            dom.modalCloseButton = document.getElementById('modal-close-button');
            dom.modalAcceptButton = document.getElementById('modal-accept-button');
            dom.paymentMethodModal = document.getElementById('payment-method-modal');
            dom.paymentClientNameSpan = document.getElementById('payment-client-name');
            dom.payCashButton = document.getElementById('pay-cash-button');
            dom.payCardButton = document.getElementById('pay-card-button');
            dom.cancelPaymentButton = document.getElementById('cancel-payment-button');
            dom.searchMyAppointmentsForm = document.getElementById('search-my-appointments-form');
            dom.myAppointmentsResultsContainer = document.getElementById('my-appointments-results-container');
            dom.searchClientNameInput = document.getElementById('search-client-name');
            dom.searchClientPhoneInput = document.getElementById('search-client-phone');
            dom.moveAppointmentSummary = document.getElementById('move-appointment-summary');
            dom.moveCalendarContainer = document.getElementById('move-calendar-container');
            dom.moveTimeSlotsContainer = document.getElementById('move-time-slots');
            dom.confirmMoveButton = document.getElementById('confirm-move-button');
            dom.backToMyAppointmentsButton = document.getElementById('back-to-my-appointments-button');
            dom.moveBarberSelect = document.getElementById('move-barber-select');
            dom.adminAvailabilityDateInput = document.getElementById('admin-availability-date');
            dom.adminAvailabilityContainer = document.getElementById('admin-availability-container');
            dom.barberAvailabilityDateInput = document.getElementById('barber-availability-date');
            dom.barberAvailabilityContainer = document.getElementById('barber-availability-container');
            dom.barberCardsContainer = document.getElementById('barber-cards-container');
            dom.scheduleDateInput = document.getElementById('schedule-date');
            dom.scheduleSettingsContainer = document.getElementById('schedule-settings-container');
            dom.setDayOpenButton = document.getElementById('set-day-open');
            dom.setDayClosedButton = document.getElementById('set-day-closed');
            dom.setDayDefaultButton = document.getElementById('set-day-default');
            dom.scheduleStartTimeInput = document.getElementById('schedule-start-time');
            dom.scheduleEndTimeInput = document.getElementById('schedule-end-time');
            dom.scheduleBarbersCheckboxes = document.getElementById('schedule-barbers-checkboxes');
            dom.saveScheduleOverrideButton = document.getElementById('save-schedule-override');
            dom.barberContactToggle = document.getElementById('barber-contact-toggle');
            dom.absenceDateInput = document.getElementById('absence-date');
            dom.absenceBarbersCheckboxes = document.getElementById('absence-barbers-checkboxes');
            dom.saveAbsencesButton = document.getElementById('save-absences-button');
            dom.chatbot = {
                bubble: document.getElementById('chatbot-bubble'),
                window: document.getElementById('chatbot-window'),
                closeButton: document.getElementById('close-chatbot'),
                messages: document.getElementById('chat-messages'),
                optionsContainer: document.getElementById('options-container'),
                inputForm: document.getElementById('input-form'),
                userInput: document.getElementById('user-input'),
                sendButton: document.getElementById('send-button'),
                icon: document.getElementById('chat-icon')
            };
            dom.registerConfirmPasswordInput = document.getElementById('register-confirm-password');
            dom.toggleLoginPassword = document.getElementById('toggle-login-password');
            dom.toggleRegisterPassword = document.getElementById('toggle-register-password');
            dom.toggleConfirmPassword = document.getElementById('toggle-confirm-password');
            // Change Password View elements
            dom.currentPasswordInput = document.getElementById('current-password');
            dom.newPasswordInput = document.getElementById('new-password');
            dom.confirmNewPasswordInput = document.getElementById('confirm-new-password');
            dom.updatePasswordButton = document.getElementById('update-password-button');
            dom.backFromChangePassword = document.getElementById('back-from-change-password');
            dom.toggleCurrentPassword = document.getElementById('toggle-current-password');
            dom.toggleNewPassword = document.getElementById('toggle-new-password');
            dom.toggleConfirmNewPassword = document.getElementById('toggle-confirm-new-password');
            // Forgot Password View elements
            dom.goToForgotPasswordLink = document.getElementById('go-to-forgot-password');
            dom.resetEmailInput = document.getElementById('reset-email');
            dom.sendResetEmailButton = document.getElementById('send-reset-email-button');
            dom.backToLoginFromReset = document.getElementById('back-to-login-from-reset');
        }

        function bindEventListeners() {
            // Navigation
            document.getElementById('barber-service-card').addEventListener('click', () => {
                utils.showView('barberAppointment');
                render.servicesForBooking();
                render.calendar();
            });
            document.getElementById('shoe-cleaning-card').addEventListener('click', () => utils.showView('shoeCleaning'));
            document.getElementById('cap-cleaning-card').addEventListener('click', () => utils.showView('capCleaning'));
            document.getElementById('my-appointments-card').addEventListener('click', () => utils.showView('myAppointments'));
            
            // Back buttons
            document.getElementById('back-to-service-selection-button').addEventListener('click', () => history.back());
            document.getElementById('back-to-service-selection-shoe-button').addEventListener('click', () => history.back());
            document.getElementById('back-to-service-selection-cap-button').addEventListener('click', () => history.back());
            document.getElementById('back-to-service-selection-admin-button').addEventListener('click', () => history.back());
            document.getElementById('back-to-service-selection-barber-button').addEventListener('click', () => history.back());
            document.getElementById('back-to-service-selection-my-appointments-button').addEventListener('click', () => history.back());
            document.getElementById('back-from-change-password').addEventListener('click', () => history.back());
            document.getElementById('go-to-register').addEventListener('click', (e) => { e.preventDefault(); utils.showView('register'); });
            document.getElementById('go-to-login').addEventListener('click', (e) => { e.preventDefault(); utils.showView('login'); });
            document.getElementById('back-to-main-from-login').addEventListener('click', (e) => { e.preventDefault(); history.back() });
            dom.goToForgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); utils.showView('forgotPassword'); });
            dom.backToLoginFromReset.addEventListener('click', (e) => { e.preventDefault(); utils.showView('login'); });

            // Auth Actions
            dom.authToggleButton.addEventListener('click', () => utils.showView('login'));
            dom.logoutButton.addEventListener('click', () => {
                if (state.unsubscribe.dashboard) {
                    state.unsubscribe.dashboard();
                    state.unsubscribe.dashboard = null;
                }
                signOut(auth).then(() => {
                    utils.showView('serviceSelection');
                }).catch(err => utils.showModal(`Error al salir: ${err.message}`));
            });
            dom.loginButton.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    const persistenceType = dom.rememberMeCheckbox.checked 
                        ? browserLocalPersistence 
                        : browserSessionPersistence;
                    
                    await setPersistence(auth, persistenceType);

                    await signInWithEmailAndPassword(auth, dom.loginEmailInput.value, dom.loginPasswordInput.value);
                    utils.showModal("¬°Inicio de sesi√≥n exitoso!");
                } catch (error) {
                    utils.showModal(error.code === 'auth/invalid-credential' ? "Correo o contrase√±a incorrectos." : "Error al iniciar sesi√≥n.");
                }
            });
            
            dom.registerButton.addEventListener('click', async (e) => {
                e.preventDefault();
                const name = dom.registerNameInput.value.trim();
                const password = dom.registerPasswordInput.value;
                const confirmPassword = dom.registerConfirmPasswordInput.value;

                if (!name) return utils.showModal("Por favor, ingresa tu nombre.");
                if (password.length < 6) return utils.showModal("La contrase√±a debe tener al menos 6 caracteres.");
                if (password !== confirmPassword) return utils.showModal("Las contrase√±as no coinciden.");

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, dom.registerEmailInput.value, password);
                    await updateProfile(userCredential.user, { displayName: name });
                    utils.showModal("¬°Registro exitoso!", () => utils.showView('serviceSelection'));
                } catch (error) {
                    utils.showModal(error.code === 'auth/email-already-in-use' ? "El correo ya est√° en uso." : "Error al registrarse.");
                }
            });
            dom.changePasswordButton.addEventListener('click', () => utils.showView('changePassword'));
            dom.updatePasswordButton.addEventListener('click', firebase.handleChangePassword);
            dom.sendResetEmailButton.addEventListener('click', firebase.handleForgotPassword);
            
            dom.confirmAppointmentButton.addEventListener('click', eventHandlers.confirmAppointment);

            // Password Toggles
            dom.toggleLoginPassword.addEventListener('click', () => utils.togglePasswordVisibility(dom.loginPasswordInput, dom.toggleLoginPassword));
            dom.toggleRegisterPassword.addEventListener('click', () => utils.togglePasswordVisibility(dom.registerPasswordInput, dom.toggleRegisterPassword));
            dom.toggleConfirmPassword.addEventListener('click', () => utils.togglePasswordVisibility(dom.registerConfirmPasswordInput, dom.toggleConfirmPassword));
            dom.toggleCurrentPassword.addEventListener('click', () => utils.togglePasswordVisibility(dom.currentPasswordInput, dom.toggleCurrentPassword));
            dom.toggleNewPassword.addEventListener('click', () => utils.togglePasswordVisibility(dom.newPasswordInput, dom.toggleNewPassword));
            dom.toggleConfirmNewPassword.addEventListener('click', () => utils.togglePasswordVisibility(dom.confirmNewPasswordInput, dom.toggleConfirmNewPassword));


            // Modals
            dom.modalCloseButton.addEventListener('click', utils.hideModal);
            dom.modalAcceptButton.addEventListener('click', utils.hideModal);
            dom.globalModal.addEventListener('click', (e) => { if (e.target === dom.globalModal) utils.hideModal(); });
            dom.cancelEditButton.addEventListener('click', () => dom.editAppointmentModal.classList.add('hidden'));
            dom.updateAppointmentButton.addEventListener('click', eventHandlers.adminUpdateAppointment);
            dom.cancelPaymentButton.addEventListener('click', () => dom.paymentMethodModal.classList.add('hidden'));
            dom.payCashButton.addEventListener('click', () => eventHandlers.markAppointmentAsAttended('cash'));
            dom.payCardButton.addEventListener('click', () => eventHandlers.markAppointmentAsAttended('card'));

            // Dashboard Actions
            dom.adminDashboardButton.addEventListener('click', () => utils.showView('adminDashboard'));
            dom.barberDashboardButton.addEventListener('click', () => utils.showView('barberDashboard'));
            
            dom.reportDateInput.addEventListener('change', () => {
                state.reportDate = dom.reportDateInput.value;
                render.dailyReports();
            });
            
            dom.adminAvailabilityDateInput.addEventListener('change', eventHandlers.displayAdminAvailability);
            dom.barberAvailabilityDateInput.addEventListener('change', eventHandlers.displayBarberAvailability);
            
            // Admin Schedule and Settings Listeners
            dom.scheduleDateInput.addEventListener('change', eventHandlers.handleScheduleDateChange);
            dom.saveScheduleOverrideButton.addEventListener('click', eventHandlers.saveScheduleOverride);
            dom.barberContactToggle.addEventListener('change', eventHandlers.updateGeneralSettings);
            dom.setDayOpenButton.addEventListener('click', () => {
                state.tempScheduleStatus = true;
                render.scheduleAdminButtons(true);
            });
            dom.setDayClosedButton.addEventListener('click', () => {
                state.tempScheduleStatus = false;
                render.scheduleAdminButtons(false);
            });
            dom.setDayDefaultButton.addEventListener('click', () => {
                state.tempScheduleStatus = undefined;
                render.scheduleAdminButtons(undefined);
            });
            dom.absenceDateInput.addEventListener('change', eventHandlers.handleAbsenceDateChange);
            dom.saveAbsencesButton.addEventListener('click', eventHandlers.saveAbsences);

            // Manual Appointment Forms
            dom.manualAddAppointmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const appointmentData = {
                    clientName: dom.manualClientNameInput.value, clientPhone: dom.manualClientPhoneInput.value, serviceId: dom.manualServiceSelect.value,
                    barberId: dom.manualBarberSelect.value, date: dom.manualDateInput.value, time: dom.manualTimeInput.value,
                    userId: 'admin_manual', createdAt: serverTimestamp(), status: 'confirmed'
                };
                if (Object.values(appointmentData).some(val => !val)) { return utils.showModal("Completa todos los campos del formulario manual."); }
                try { 
                    await addDoc(collection(db, "appointments"), appointmentData); 
                    utils.showModal("Cita manual agregada con √©xito."); 
                    dom.manualAddAppointmentForm.reset(); 
                } catch (error) { 
                    utils.showModal(`Error al agregar cita: ${error.message}`); 
                }
            });
            dom.barberManualAddForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const appointmentData = {
                    clientName: dom.barberManualClientNameInput.value, clientPhone: dom.barberManualClientPhoneInput.value, serviceId: dom.barberManualServiceSelect.value,
                    barberId: state.loggedInBarberId, date: dom.barberManualDateInput.value, time: dom.barberManualTimeInput.value,
                    userId: 'barber_manual', createdAt: serverTimestamp(), status: 'confirmed'
                };
                if (!appointmentData.clientName || !appointmentData.serviceId || !appointmentData.date || !appointmentData.time) {
                    return utils.showModal("Completa todos los campos del formulario.");
                }
                try { 
                    await addDoc(collection(db, "appointments"), appointmentData); 
                    utils.showModal("Cita manual agregada con √©xito."); 
                    dom.barberManualAddForm.reset(); 
                } catch (error) { 
                    utils.showModal(`Error al agregar cita: ${error.message}`); 
                }
            });
            
            // Client-side appointment management listeners
            dom.searchMyAppointmentsForm.addEventListener('submit', eventHandlers.searchMyAppointments);
            dom.confirmMoveButton.addEventListener('click', eventHandlers.confirmMoveAppointment);
            dom.backToMyAppointmentsButton.addEventListener('click', () => history.back());
            dom.moveBarberSelect.addEventListener('change', eventHandlers.handleMoveBarberChange);

            // Chatbot event listeners
            dom.chatbot.bubble.addEventListener('click', () => chatbot.toggle());
            dom.chatbot.closeButton.addEventListener('click', () => chatbot.toggle());
            dom.chatbot.sendButton.addEventListener('click', () => {
                if (dom.chatbot.userInput.value.trim()) {
                    chatbot.handleUserInput(dom.chatbot.userInput.value.trim());
                    dom.chatbot.userInput.value = '';
                }
            });
            dom.chatbot.userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && dom.chatbot.userInput.value.trim()) {
                    chatbot.handleUserInput(dom.chatbot.userInput.value.trim());
                    dom.chatbot.userInput.value = '';
                }
            });

            // Browser history listener
            window.addEventListener('popstate', eventHandlers.handlePopState);
        }

        function initApp() {
            cacheDomElements();

            dom.chatbot.window.style.display = 'none';
            dom.chatbot.icon.className = 'fas fa-comments';

            firebase.initialize();
            firebase.handleAuth();
            bindEventListeners();

            // --- Google Sign-In Initialization using GSI Library ---
            try {
                const GOOGLE_CLIENT_ID = "417011094347-rbnrr6b253htvog4t8mb8o57pi8pf9ce.apps.googleusercontent.com"; 

                if (GOOGLE_CLIENT_ID === "YOUR_GOOGLE_WEB_CLIENT_ID") {
                    dom.googleLoginButtonContainer.innerHTML = `<p class="text-center text-sm text-red-600"><b>Error de Configuraci√≥n:</b><br>Se requiere un Google Web Client ID para el inicio de sesi√≥n con Google.</p>`;
                } else {
                    // Make the callback function globally accessible for Google's script
                    window.handleGoogleCredentialResponse = firebase.handleGoogleCredentialResponse;

                    google.accounts.id.initialize({
                        client_id: GOOGLE_CLIENT_ID,
                        callback: window.handleGoogleCredentialResponse
                    });
                    google.accounts.id.renderButton(
                        dom.googleLoginButtonContainer,
                        { theme: "outline", size: "large", text: "continue_with", width: "300", locale: "es-419" } 
                    );
                }
            } catch (e) {
                console.error("Google Identity Services library not loaded or failed to initialize.", e);
                dom.googleLoginButtonContainer.innerHTML = `<p class="text-center text-sm text-red-600">No se pudo cargar el inicio de sesi√≥n con Google.</p>`;
            }
            
            const currentHash = window.location.hash.replace('#', '');
            if (currentHash && dom.views[currentHash]) {
                utils.showView(currentHash, false);
            } else {
                utils.showView('serviceSelection', false);
            }

            const todayString = utils.getLocalDateString();
            dom.reportDateInput.value = todayString;
            dom.adminAvailabilityDateInput.value = todayString;
            dom.barberAvailabilityDateInput.value = todayString;
            dom.absenceDateInput.value = todayString;
            eventHandlers.handleAbsenceDateChange(); // Load absences for today initially


            const serviceOptions = config.services.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            dom.manualServiceSelect.innerHTML = serviceOptions;
            dom.barberManualServiceSelect.innerHTML = serviceOptions;
            dom.manualBarberSelect.innerHTML = config.barbers.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            dom.barberManualDateInput.value = todayString;
        }

        // --- Start the application ---
        window.onload = initApp;

    </script>
</body>
</html>

